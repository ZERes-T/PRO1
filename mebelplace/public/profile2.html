<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Профиль — mebelplace</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root{
    --bg:#0b0b0f; --panel:#11131a; --panel2:#1a1e2c; --line:#232b3a;
    --text:#e5e7eb; --muted:#9aa3b2; --accent:#f59e0b; --accent2:#ffb341;
    --radius:12px; --hdr:56px; --tabbar-h:64px; --maxw:920px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Segoe UI,Inter,Roboto,Ubuntu}
  a{color:inherit;text-decoration:none}

  /* header */
  header{
    position:sticky;top:0;z-index:60;height:var(--hdr);
    display:flex;align-items:center;gap:12px;padding:0 14px;
    background:#0b0b0fcc;border-bottom:1px solid var(--line);backdrop-filter:blur(8px)
  }
  .title{font-weight:900;color:var(--accent)}
  .grow{flex:1}
  .btn{height:36px;padding:0 12px;border-radius:10px;border:1px solid var(--line);background:#121621;color:#fff;font-weight:800;cursor:pointer}
  .btn:hover{background:#161a22}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#1b1304}
  .iconbtn{background:none;border:0;color:var(--text);cursor:pointer;font-size:18px}

  /* layout */
  .container{max-width:var(--maxw);margin:0 auto;padding:14px 14px calc(14px + var(--tabbar-h) + env(safe-area-inset-bottom))}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px}

  /* profile header */
  .center{display:flex;flex-direction:column;align-items:center}
  .avatar{width:100px;height:100px;border-radius:50%;border:3px solid var(--accent);display:grid;place-items:center;background:var(--panel2);font-weight:900;font-size:32px;margin:8px 0}
  .name{font-size:22px;font-weight:900}
  .uname{color:var(--muted);margin-top:4px}
  .stats{display:flex;gap:20px;margin:12px 0}
  .stat{display:flex;flex-direction:column;align-items:center}
  .val{color:var(--accent);font-weight:900}
  .lab{color:var(--muted);font-size:13px}
  .bio{max-width:680px;text-align:center;margin:8px auto 0}

  .actions{display:flex;gap:10px;margin-top:14px}
  .actions .btn{display:flex;align-items:center;gap:8px}

  /* tabs */
  .tabs{display:flex;border-bottom:1px solid var(--line);margin:16px 0}
  .tab{flex:1;text-align:center;padding:12px 0;font-weight:800;color:var(--muted);cursor:pointer;border-bottom:2px solid transparent}
  .tab.active{color:var(--accent);border-color:var(--accent)}

  /* grids */
  .grid-v{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
  .tile{position:relative;aspect-ratio:9/16;border-radius:12px;overflow:hidden;background:#0f121b;border:1px solid #262c3a}
  .tile img{width:100%;height:100%;object-fit:cover}
  .vstats{position:absolute;left:6px;right:6px;bottom:6px;display:flex;justify-content:space-between;gap:6px;
          background:rgba(0,0,0,.6);backdrop-filter:blur(6px);padding:4px 8px;border-radius:10px;font-size:12px}

  .grid-f{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
  .fav{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:12px}
  .favHead{display:flex;align-items:center;gap:10px;margin-bottom:8px}
  .chipA{width:36px;height:36px;border-radius:50%;background:#0f131d;display:grid;place-items:center;border:1px solid #2a3142;font-weight:800;color:var(--accent)}

  .olist{display:flex;flex-direction:column;gap:10px}
  .order{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:12px;display:flex;justify-content:space-between;align-items:center}
  .ost{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:800}
  .ok{background:#072118;color:#a7f3d0;border:1px solid #165b47}
  .wait{background:#2b2430;color:#e1c9ff;border:1px solid #4b3557}
  .pend{background:#33250e;color:#facc15;border:1px solid #694c15}

  .empty{border:1px dashed #2b364d;border-radius:12px;padding:18px;text-align:center;color:#9aa3b2}

  /* upload */
  .upload{background:var(--panel2);border:1px solid var(--line);border-radius:12px;padding:16px;margin-bottom:14px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .input{height:40px;padding:0 10px;border-radius:10px;border:1px solid var(--line);background:#0b0d13;color:#e5e7eb}
  .input.wide{min-width:220px;flex:1}
  .msg{display:none;margin:10px 0;padding:10px;border-radius:10px;font-size:14px}
  .msg.ok{display:block;background:#072118;border:1px solid #0a3e2c;color:#a7f3d0}
  .msg.err{display:block;background:#2a1313;border:1px solid #803131;color:#fecaca}
  .prog{height:8px;background:#11151f;border:1px solid #223148;border-radius:999px;overflow:hidden;margin-top:10px}
  .bar{height:100%;width:0;background:linear-gradient(90deg,#f59e0b,#ffb341)}

  /* bottom nav */
  .tabbar{
    position:fixed;left:0;right:0;bottom:0;z-index:50;
    display:grid;grid-template-columns:repeat(5,1fr);
    height:var(--tabbar-h);background:#0b0b0f;border-top:1px solid var(--line);
    padding-bottom:env(safe-area-inset-bottom)
  }
  .tabbar a{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:13px;font-weight:800;color:#9ca3af}
  .tabbar a.active{color:#f59e0b}
  .tabbar a svg{color:currentColor}

  /* responsive */
  @media (max-width:768px){ .grid-v{grid-template-columns:repeat(2,1fr)} .grid-f{grid-template-columns:1fr} }
  @media (max-width:420px){ .actions{flex-direction:column;width:100%} .actions .btn{width:100%} }
  @media (min-width:1200px){ .container{max-width:414px;margin:0 auto;border-left:1px solid var(--line);border-right:1px solid var(--line)} }
</style>
</head>
<body>
<header>
  <button class="iconbtn" onclick="history.back()" aria-label="Назад"><i class="fas fa-arrow-left"></i></button>
  <div class="title">Профиль</div>
  <div class="grow"></div>
  <button id="btnSettings" class="iconbtn" aria-label="Настройки"><i class="fas fa-cog"></i></button>
</header>

<main class="container">
  <!-- профиль -->
  <section class="card center" id="profileBox">
    <div id="avatar" class="avatar">?</div>
    <div class="name" id="name">Загрузка…</div>
    <div class="uname" id="uname"></div>

    <div class="stats" id="stats">
      <div class="stat"><div class="val" id="followers">0</div><div class="lab">Подписчики</div></div>
      <div class="stat"><div class="val" id="likes">0</div><div class="lab">Лайки</div></div>
      <div class="stat"><div class="val" id="orders">0</div><div class="lab">Заказы</div></div>
    </div>

    <div class="bio" id="bio"></div>

    <div class="actions">
      <button id="btnEdit" class="btn primary"><i class="fas fa-edit"></i> Редактировать</button>
      <button id="btnShare" class="btn"><i class="fas fa-share-alt"></i> Поделиться</button>
    </div>
  </section>

  <!-- табы -->
  <div class="tabs">
    <div class="tab active" data-tab="videos">Видео</div>
    <div class="tab" data-tab="favorites">Избранное</div>
    <div class="tab" data-tab="orders">Заказы</div>
  </div>

  <!-- загрузка видео (для мастеров) -->
  <section class="upload" id="uploadBox">
    <strong style="display:block;margin-bottom:8px">Загрузить видео</strong>
    <div class="row">
      <input id="file" type="file" accept="video/*" class="input">
      <input id="title" class="input wide" placeholder="Заголовок">
      <input id="tags" class="input wide" placeholder="#теги через пробел">
      <button id="btnUpload" class="btn primary">Загрузить</button>
    </div>
    <div id="umsg" class="msg" role="status"></div>
    <div class="prog" aria-hidden="true"><div id="ubar" class="bar"></div></div>
  </section>

  <!-- контент: видео -->
  <section id="videosContent" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div class="section-title" style="color:var(--accent);font-weight:900">Мои видео</div>
      <button id="btnReloadVideos" class="btn">Обновить</button>
    </div>
    <div id="videosGrid" class="grid-v"></div>
    <div id="videosEmpty" class="empty" style="display:none">Видео пока нет</div>
  </section>

  <!-- контент: избранное -->
  <section id="favoritesContent" class="card" style="display:none">
    <div class="section-title" style="color:var(--accent);font-weight:900">Избранное</div>
    <div id="favGrid" class="grid-f"></div>
    <div id="favEmpty" class="empty" style="display:none">Пусто</div>
  </section>

  <!-- контент: заказы -->
  <section id="ordersContent" class="card" style="display:none">
    <div class="section-title" style="color:var(--accent);font-weight:900">Заказы</div>
    <div id="ordersList" class="olist"></div>
    <div id="ordersEmpty" class="empty" style="display:none">Пока нет заказов</div>
  </section>
</main>

<!-- НИЖНЯЯ НАВИГАЦИЯ как на остальных страницах -->
<nav class="tabbar" id="tabbar">
  <a href="/" data-path="/"><svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3 2 12h3v9h6v-6h2v6h6v-9h3z"/></svg><span>Лента</span></a>
  <a href="/subs.html" data-path="/subs.html"><svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05A6.1 6.1 0 0 1 18 16.5V19h6v-2.5C24 14.57 20.33 13 16 13z"/></svg><span>Подписки</span></a>
  <a href="/requests.html" data-path="/requests.html"><svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M7 3h10a2 2 0 0 1 2 2v14l-7-3l-7 3V5a2 2 0 0 1 2-2z"/></svg><span>Заявка всем</span></a>
  <a href="/messenger.html" data-path="/messenger.html"><svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/></svg><span>Мессенджер</span></a>
  <a href="/profile.html" data-path="/profile.html" class="active"><svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14z"/></svg><span>Профиль</span></a>
</nav>

<script>
/* --- helpers/transport (совместимо с твоими страницами) --- */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function tok(){ try{return localStorage.getItem('token')||''}catch{return''} }
function needAuth(){ if(!tok()) location.replace('/login.html?next=/profile.html') }
function hdr(extra){ const h = extra? {...extra}: {}; const t=tok(); if(t) h['Authorization']='Bearer '+t; return h }

/* JSON fetch (как на других страницах) */
async function j(url,opts){
  opts=opts||{};
  const isJSON = !!opts.body && !(opts.body instanceof FormData);
  const r = await fetch(url,{
    method:opts.method||'GET',
    headers:Object.assign({}, isJSON?{'Content-Type':'application/json'}:{}, hdr(opts.headers)),
    body: isJSON? JSON.stringify(opts.body): (opts.body||undefined),
    credentials:'include'
  });
  const ct=r.headers.get('content-type')||'';
  const data = ct.includes('json')? await r.json().catch(()=>({})) : {};
  if(!r.ok) throw new Error((data && (data.error||data.message)) || ('HTTP '+r.status));
  return data;
}

/* пробуем несколько эндпоинтов — берём первый успешный */
async function tryFetchJson(urls, opts){ for(const u of urls){ try{ return await j(u,opts) }catch(e){} } throw new Error('Нет данных') }
async function tryFetchRaw(urls, opts){
  for(const u of urls){
    try{
      const r = await fetch(u,Object.assign({credentials:'include', headers:hdr()},opts||{}));
      if(r.ok) return await r.json().catch(()=>({}));
    }catch(e){}
  }
  throw new Error('Нет данных');
}

/* аватар-местозаполнитель */
const avatarUrl = seed => `https://api.dicebear.com/8.x/thumbs/svg?seed=${encodeURIComponent(seed||'mebel')}`;
const thumbUrl  = seed => `https://api.dicebear.com/8.x/identicon/svg?seed=${encodeURIComponent(seed||'mebel')}`;

/* --- state --- */
const S = { me:null, videos:[], favs:[], orders:[] };

/* --- UI utils --- */
function setText(id, val){ const el=$(id); if(el) el.textContent=val; }
function fmt(n){ n=Number(n||0); if(n>=1_000_000) return (n/1_000_000).toFixed(1).replace('.0','')+'м'; if(n>=1000) return (n/1000).toFixed(1).replace('.0','')+'к'; return String(n) }
function firstLetter(s){ s=String(s||'').trim(); return s? s[0].toUpperCase():'?' }

/* --- profile load/update --- */
async function loadProfile(){
  try{
    const me = await tryFetchJson(['/api/me','/api/profile','/api/user/me']);
    S.me = me;
    $('#avatar').innerHTML = '';
    $('#avatar').style.backgroundImage = me.avatar? `url(${me.avatar})` : 'none';
    if(!me.avatar) $('#avatar').textContent = firstLetter(me.name||me.username||'M');
    $('#name').textContent = me.name || 'Без имени';
    $('#uname').textContent = me.username ? '@'+me.username : (me.email||'');
    $('#bio').textContent = me.bio || '';
    $('#followers').textContent = fmt(me.followers||me.subscribers||0);
    $('#likes').textContent = fmt(me.likes||0);
    // orders count обновим после загрузки заказов
  }catch(e){
    $('#name').textContent='Профиль'; $('#uname').textContent='';
    $('#bio').textContent='';
  }
}

/* --- videos --- */
function renderVideos(){
  const box = $('#videosGrid'), empty = $('#videosEmpty'); box.innerHTML='';
  if(!S.videos.length){ empty.style.display='block'; return } else empty.style.display='none';
  for(const v of S.videos){
    const img = v.thumb || v.poster || v.preview || thumbUrl(v.id||v.owner_id);
    const likes = fmt(v.likes||0), comments = fmt(v.comments||0);
    const a = document.createElement('a'); a.className='tile'; a.href = v.url ? (`/?v=${encodeURIComponent(v.id||'')}`) : '#';
    a.innerHTML = `<img src="${img}" alt=""><div class="vstats"><span><i class="fas fa-heart"></i> ${likes}</span><span><i class="fas fa-comment"></i> ${comments}</span></div>`;
    box.appendChild(a);
  }
}
async function loadVideos(){
  try{
    // пробуем получить только свои видео
    const qs = S.me?.id ? [`/api/media.php?owner_id=${encodeURIComponent(S.me.id)}`] : [];
    qs.push('/api/media.php','/api/videos?mine=1','/api/videos');
    const data = await tryFetchRaw(qs);
    const items = Array.isArray(data)?data:(data.items||[]);
    // если вернулись все видео, пробуем отфильтровать по owner_id
    const list = (S.me && items.some(x=>'owner_id' in x)) ? items.filter(x=>String(x.owner_id)===String(S.me.id)) : items;
    S.videos = list.map(x=>({id:x.id, url:x.url, thumb:x.thumb, poster:x.poster, preview:x.preview, owner_id:x.owner_id, likes:x.likes, comments:x.comments}));
  }catch(e){ S.videos=[] }
  renderVideos();
}

/* --- favorites --- */
function renderFavs(){
  const box = $('#favGrid'), empty = $('#favEmpty'); box.innerHTML='';
  if(!S.favs.length){ empty.style.display='block'; return } else empty.style.display='none';
  for(const f of S.favs){
    const el = document.createElement('div'); el.className='fav';
    const letter = firstLetter(f.user_name||f.username||'U');
    el.innerHTML = `
      <div class="favHead"><div class="chipA">${letter}</div><div><div style="font-weight:800">${f.user_name||f.username||'@user'}</div>
      <div style="font-size:12px;color:var(--muted)">${f.created_at? new Date(f.created_at).toLocaleString() : ''}</div></div></div>
      <div>${(f.text||f.comment||'').toString().slice(0,300)}</div>`;
    box.appendChild(el);
  }
}
async function loadFavs(){
  try{
    const data = await tryFetchRaw(['/api/favorites','/api/likes?mine=1','/api/bookmarks']);
    const items = Array.isArray(data)?data:(data.items||[]);
    S.favs = items;
  }catch(e){ S.favs=[] }
  renderFavs();
}

/* --- orders --- */
function renderOrders(){
  const box = $('#ordersList'), empty=$('#ordersEmpty'); box.innerHTML='';
  if(!S.orders.length){ empty.style.display='block'; $('#orders').textContent='0'; return } else empty.style.display='none';
  $('#orders').textContent = fmt(S.orders.length);
  for(const o of S.orders){
    const st = (o.status||'').toLowerCase();
    const cls = st.includes('clos')||st.includes('done')||st.includes('comp') ? 'ok'
              : st.includes('wait')||st.includes('hold') ? 'wait' : 'pend';
    const el = document.createElement('div'); el.className='order';
    el.innerHTML = `
      <div>
        <div style="font-weight:800">${o.title||'Заказ'}</div>
        <div style="color:var(--muted);font-size:13px">${o.createdAt? new Date(o.createdAt).toLocaleDateString() : (o.created_at? new Date(o.created_at).toLocaleDateString() : '')}</div>
      </div>
      <div class="ost ${cls}">${o.status||'В работе'}</div>`;
    box.appendChild(el);
  }
}
async function loadOrders(){
  try{
    const data = await tryFetchRaw(['/api/orders?mine=1','/api/requests?mine=1','/api/requests']);
    let items = Array.isArray(data)?data:(data.items||[]);
    // если /api/requests вернуло все заявки, пробуем отфильтровать свои
    if(S.me && items.some(x=>'user_id' in x)) items = items.filter(x=>String(x.user_id)===String(S.me.id));
    S.orders = items.map(x=>({
      title:x.title, status:(x.status||'').toLowerCase(), createdAt:x.createdAt||x.created_at
    }));
  }catch(e){ S.orders=[] }
  renderOrders();
}

/* --- upload video (реально загружает) --- */
async function uploadVideo(){
  const file = $('#file').files[0];
  const title = $('#title').value.trim();
  const tags = $('#tags').value.trim();

  const msg = $('#umsg'); const bar = $('#ubar');
  function showOk(t){ msg.className='msg ok'; msg.textContent=t; }
  function showErr(t){ msg.className='msg err'; msg.textContent=t; }

  if(!file){ showErr('Выберите файл'); return }
  if(title.length<2){ showErr('Короткий заголовок'); return }

  const fd = new FormData();
  fd.append('file', file);
  fd.append('title', title);
  if(tags) fd.append('tags', tags);

  // пробуем несколько возможных точек
  const endpoints = ['/api/media.php','/api/upload','/api/videos'];
  let uploaded=false, lastErr=null;

  for(const url of endpoints){
    try{
      await fetch(url,{
        method:'POST',
        headers: hdr(), // важен только Authorization; Content-Type формдата поставит сам браузер
        body: fd,
        credentials:'include',
        signal: (()=>{
          // прогресс (XHR через fetch недоступен, поэтому сделаем XHR вручную)
          return undefined;
        })()
      }).then(async r=>{
        if(!r.ok) throw new Error('HTTP '+r.status);
        try{ await r.json() }catch{}
      });
      uploaded=true; break;
    }catch(e){ lastErr=e }
  }

  if(uploaded){
    bar.style.width='100%'; showOk('Загружено');
    $('#file').value=''; $('#title').value=''; $('#tags').value='';
    await loadVideos();
  }else{
    showErr(lastErr?.message || 'Ошибка загрузки');
  }
}

/* XHR с прогрессом (используем там, где есть /api/media.php) */
function uploadWithProgressXHR(url, formData, onProgress){
  return new Promise((resolve,reject)=>{
    const xhr = new XMLHttpRequest();
    xhr.open('POST', url, true);
    const t=tok(); if(t) xhr.setRequestHeader('Authorization','Bearer '+t);
    xhr.withCredentials = true;
    xhr.upload.onprogress = e=>{ if(e.lengthComputable) onProgress(Math.round((e.loaded/e.total)*100)) };
    xhr.onload = ()=>{ if(xhr.status>=200 && xhr.status<300){ try{ resolve(JSON.parse(xhr.responseText)) }catch{ resolve({}) } } else reject(new Error('HTTP '+xhr.status)) };
    xhr.onerror = ()=>reject(new Error('Network error'));
    xhr.send(formData);
  });
}

/* --- init --- */
function initTabs(){
  $$('.tab').forEach(t=>{
    t.addEventListener('click', ()=>{
      $$('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
      $('#videosContent').style.display = (t.dataset.tab==='videos')?'block':'none';
      $('#favoritesContent').style.display = (t.dataset.tab==='favorites')?'block':'none';
      $('#ordersContent').style.display = (t.dataset.tab==='orders')?'block':'none';
    });
  });
}
function initBottomNav(){
  const cur = (location.pathname.replace(/\/+$/,'') || '/');
  $$('#tabbar a').forEach(a=>{
    const p=a.getAttribute('data-path'); const isHome=(p==='/'&&(cur==='/'||cur==='/index.html'));
    a.classList.toggle('active', isHome || p===cur);
  });
}
function initActions(){
  $('#btnShare').addEventListener('click', async ()=>{
    const url = location.origin + '/profile.html';
    try{
      if(navigator.share){ await navigator.share({title:'Профиль mebelplace', url}) }
      else{ await navigator.clipboard.writeText(url); }
    }catch{}
  });

  $('#btnUpload').addEventListener('click', async ()=>{
    const msg = $('#umsg'); const bar=$('#ubar'); msg.className='msg'; msg.textContent='';
    const fd = new FormData(); const f=$('#file').files[0];
    if(!f){ msg.className='msg err'; msg.textContent='Выберите файл'; return }
    fd.append('file', f); fd.append('title',$('#title').value.trim()); fd.append('tags',$('#tags').value.trim());

    // если есть /api/media.php — используем XHR для реального прогресса
    try{
      await uploadWithProgressXHR('/api/media.php', fd, p=>{ bar.style.width=p+'%'; });
      msg.className='msg ok'; msg.textContent='Загружено'; await loadVideos(); $('#file').value=''; $('#title').value=''; $('#tags').value='';
      return;
    }catch(e){ /* попробуем остальные */ }

    // иначе обычный fetch (без прогресса)
    $('#ubar').style.width='0%';
    await uploadVideo();
  });

  $('#btnSettings').addEventListener('click', ()=> location.href='/profile.edit.html');
  $('#btnEdit').addEventListener('click', ()=> location.href='/profile.edit.html');
  $('#btnReloadVideos').addEventListener('click', loadVideos);
}

/* go */
document.addEventListener('DOMContentLoaded', async ()=>{
  needAuth();
  initTabs(); initBottomNav(); initActions();
  await loadProfile();
  await Promise.all([loadVideos(), loadFavs(), loadOrders()]);
});
</script>
</body>
</html>
