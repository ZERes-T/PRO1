<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>–í—Ö–æ–¥ ‚Äî mebelplace</title>
<link rel="stylesheet" href="/common.css">
<style>
  :root { --accent:#f59e0b; --bg:#0b0b0f; --muted:#cbd5e1 }
  html,body{height:100%;background:#000;color:#fff}
  body{display:grid;place-items:center;min-height:100dvh;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
  .drops{position:fixed;inset:-10vh;background:radial-gradient(1200px 1200px at 50% 100%,#0a0a0a 0%, #000 60%)}
  .drops i{position:absolute;display:block;border-radius:50%;
    background:radial-gradient(circle at 35% 35%,rgba(255,255,255,.18),rgba(255,255,255,.04) 35%,rgba(255,255,255,0) 70%);
    filter:blur(1px);opacity:.45;transform:translate(var(--tx),var(--ty)) scale(.7);
    animation:puff var(--dur) ease-in-out var(--delay) infinite;will-change:transform,opacity}
  @keyframes puff{0%{transform:translate(var(--tx),var(--ty)) scale(.7);opacity:.35}
    50%{transform:translate(calc(var(--tx) + var(--dx)),calc(var(--ty) + var(--dy))) scale(1.2);opacity:.7}
    100%{transform:translate(var(--tx),var(--ty)) scale(.7);opacity:.35}}
  .wrap{position:relative;z-index:2;width:min(440px,92vw)}
  .glass{backdrop-filter:blur(10px);background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.14);
    border-radius:20px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .brand{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .brand b{font-size:20px;letter-spacing:.3px}
  .tabs{display:flex;gap:8px;margin:8px 0 14px}
  .tab{flex:1;height:46px;border-radius:12px;border:none;background:#16181f;color:#fff;font-weight:900;cursor:pointer}
  .tab.active{background:#fff;color:#000}
  label{display:block;font-size:13px;color:#eaeef7;margin:8px 2px 6px;font-weight:800;letter-spacing:.2px}
  .field{position:relative}
  .field .icon{position:absolute;left:12px;top:50%;transform:translateY(-50%);opacity:.75}
  .input{width:100%;height:48px;border-radius:12px;padding:0 14px 0 42px;color:#fff;background:#0e0f12;border:1px solid rgba(255,255,255,.18)}
  .input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(245,158,11,.25)}
  .hint{display:flex;justify-content:space-between;align-items:center;margin-top:6px}
  .muted{color:#aeb6c3}.link{color:#fff}
  .btn{height:46px;border-radius:12px;padding:0 14px;font-weight:900;border:none;cursor:pointer}
  .btn:disabled{opacity:.6}
  .btn-primary{background:var(--accent);color:#111;box-shadow:0 8px 18px rgba(245,158,11,.35)}
  .btn-primary:focus{outline:none;box-shadow:0 0 0 3px rgba(245,158,11,.35)}
  .btn.ghost{background:#fff;color:#000}
  .err,.ok{display:none;border-radius:12px;padding:10px;margin-top:8px;font-size:14px}
  .err{background:#2b0f12;color:#ffb4b4;border:1px solid #7a2830}
  .ok{background:#0f2b18;color:#bfffd4;border:1px solid #2e7a52}
  .foot{display:flex;gap:10px;margin-top:12px}

  /* —Ä–æ–ª—å ‚Äî –∫—Ä—É–ø–Ω—ã–µ ¬´–ø–∏–ª—é–ª–∏¬ª */
  .roles{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:6px 0 10px}
  .role{position:relative;border:1px solid rgba(255,255,255,.18);background:#0e0f12;border-radius:12px;padding:10px;cursor:pointer}
  .role input{position:absolute;opacity:0;inset:0;cursor:pointer}
  .role h4{margin:0 0 2px;font-size:14px}
  .role p{margin:0;color:#aeb6c3;font-size:12px}
  .role:has(input:checked){border-color:var(--accent);box-shadow:0 0 0 3px rgba(245,158,11,.25);background:#141416}
</style>
</head>
<body>
<div class="drops" aria-hidden="true" id="drops"></div>

<div class="wrap">
  <div class="glass">
    <div class="brand">
      <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 24 24' fill='%23f59e0b'%3E<path d='M12 2l3 5 6 .9-4.3 4.2 1 5.9L12 15l-5.7 3 1-5.9L3 7.9 9 7z'/></svg>" alt="">
      <b>mebelplace</b>
    </div>

    <div class="tabs" role="tablist" aria-label="–í—ã–±–æ—Ä —Ñ–æ—Ä–º—ã">
      <button class="tab active" id="tLogin" role="tab" aria-selected="true" aria-controls="fLogin">–í–æ–π—Ç–∏</button>
      <button class="tab" id="tReg" role="tab" aria-selected="false" aria-controls="fReg">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <!-- –í—Ö–æ–¥ -->
    <form id="fLogin" autocomplete="on" role="tabpanel" aria-labelledby="tLogin">
      <label for="lEmail">–≠–ª. –ø–æ—á—Ç–∞</label>
      <div class="field">
        <span class="icon">‚úâÔ∏è</span>
        <input class="input" style="padding:0 14px 0 42px" id="lEmail" name="email" type="email" inputmode="email" placeholder="–ü–æ—á—Ç–∞" required>
      </div>

      <div class="hint">
        <label for="lPass" style="margin:0">–ü–∞—Ä–æ–ª—å</label>
        <button type="button" id="showL" class="btn ghost" style="height:36px">–ü–æ–∫–∞–∑–∞—Ç—å</button>
      </div>
      <div class="field">
        <span class="icon">üîí</span>
        <input class="input" id="lPass" name="password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>

      <div id="lErr" class="err" role="alert"></div>
      <div id="lOk"  class="ok"></div>
      <div class="foot">
        <button class="btn btn-primary" id="btnLogin" type="submit" style="flex:1">–í–æ–π—Ç–∏</button>
      </div>
    </form>

    <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <form id="fReg" style="display:none" role="tabpanel" aria-labelledby="tReg">
      <label for="rName">–ò–º—è</label>
      <div class="field">
        <span class="icon">üë§</span>
        <input class="input" id="rName" name="name" placeholder="–ò–≤–∞–Ω" required>
      </div>

      <label for="rEmail">–≠–ª. –ø–æ—á—Ç–∞</label>
      <div class="field">
        <span class="icon">‚úâÔ∏è</span>
        <input class="input" style="padding:0 14px 0 42px" id="rEmail" name="email" type="email" inputmode="email" placeholder="–ü–æ—á—Ç–∞" required>
      </div>

      <div class="hint">
        <label for="rPass" style="margin:0">–ü–∞—Ä–æ–ª—å</label>
        <button type="button" id="showR" class="btn ghost" style="height:36px">–ü–æ–∫–∞–∑–∞—Ç—å</button>
      </div>
      <div class="field">
        <span class="icon">üîí</span>
        <input class="input" id="rPass" name="password" type="password" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" minlength="6" required autocomplete="new-password">
      </div>

      <label>–†–æ–ª—å</label>
      <div class="roles" role="radiogroup" aria-label="–í—ã–±–æ—Ä —Ä–æ–ª–∏">
        <label class="role">
          <input type="radio" name="role" value="buyer" checked>
          <h4 value="buyer">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å</h4>
          <p>–°–æ–∑–¥–∞—é –∑–∞—è–≤–∫–∏ –∏ –≤—ã–±–∏—Ä–∞—é –º–∞—Å—Ç–µ—Ä–æ–≤</p>
        </label>
        <label class="role">
          <input type="radio" name="role" value="master">
          <h4 value="master">–ü—Ä–æ–¥–∞–≤–µ—Ü</h4>
          <p>–ü–æ–ª—É—á–∞—é –∑–∞—è–≤–∫–∏ –∏ –æ—Ç–≤–µ—á–∞—é –∫–ª–∏–µ–Ω—Ç–∞–º</p>
        </label>
      </div>

      <div id="rErr" class="err" role="alert"></div>
      <div id="rOk"  class="ok"></div>
      <button class="btn btn-primary" id="btnReg" type="submit" style="width:100%">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
    </form>

    <div class="muted" style="margin-top:10px">
      –ù–∞–∂–∏–º–∞—è ¬´–í–æ–π—Ç–∏¬ª/¬´–°–æ–∑–¥–∞—Ç—å¬ª, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å <a href="/legal/terms" class="link">—É—Å–ª–æ–≤–∏—è–º–∏ —Å–µ—Ä–≤–∏—Å–∞</a>.
    </div>
  </div>
</div>

<script>
(()=> {
  // —Ñ–æ–Ω
  const drops = document.getElementById('drops');
  for (let i=0;i<14;i++){
    const e=document.createElement('i');
    const tx=Math.random()*100, ty=Math.random()*100;
    e.style.setProperty('--tx', tx+'vw'); e.style.setProperty('--ty', ty+'vh');
    e.style.setProperty('--dx', (Math.random()*16-8)+'vmin');
    e.style.setProperty('--dy', (Math.random()*10-5)+'vmin');
    e.style.setProperty('--dur', (10+Math.random()*10)+'s');
    e.style.setProperty('--delay', (Math.random()*-8)+'s');
    const s=(12+Math.random()*18)+'vmin'; e.style.width=s; e.style.height=s;
    drops.appendChild(e);
  }

  // utils
  const ORIGIN = location.origin.replace(/\.$/, '');
  const api    = (p) => ORIGIN + p;
  const $ = s => document.querySelector(s);
  const nextUrl = new URLSearchParams(location.search).get('next') || '/';
  const setLoading = (btn,on,txt='')=>{ btn.disabled=on; if(on){ btn.dataset.t=btn.textContent; btn.textContent=txt||'–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶' } else { btn.textContent=btn.dataset.t||btn.textContent } };
  const show = (el,msg)=>{ el.textContent=msg; el.style.display='block' };
  const hide = (el)=>{ el.style.display='none' };
  const saveToken = t => { try{ localStorage.setItem('token',t) }catch{} };

  // —Ç–∞–±—ã
  const tLogin=$('#tLogin'), tReg=$('#tReg'), fLogin=$('#fLogin'), fReg=$('#fReg');
  function swap(mode){ const login=(mode==='login');
    fLogin.style.display = login?'block':'none';
    fReg.style.display   = login?'none':'block';
    tLogin.classList.toggle('active',login);
    tReg.classList.toggle('active',!login);
    tLogin.setAttribute('aria-selected', login?'true':'false');
    tReg.setAttribute('aria-selected', !login?'true':'false');
  }
  tLogin.onclick=()=>swap('login'); tReg.onclick=()=>swap('reg');

  // –≤—Ö–æ–¥
  $('#showL').onclick = ()=>{ const p=$('#lPass'); p.type = p.type==='password'?'text':'password' };
  fLogin.addEventListener('submit', async (e)=>{
    e.preventDefault(); hide($('#lErr')); hide($('#lOk')); setLoading($('#btnLogin'),true,'–í—Ö–æ–¥–∏–º‚Ä¶');
    try{
      const r = await fetch(api('/api/auth/login'), {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email: $('#lEmail').value.trim(), password: $('#lPass').value })
      });
      const js = await r.json().catch(()=>({}));
      if(!r.ok || !js.token) throw new Error(js.error || (r.status===403?'–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω':'–ù–µ–≤–µ—Ä–Ω—ã–µ –ø–æ—á—Ç–∞ –∏–ª–∏ –ø–∞—Ä–æ–ª—å'));
      saveToken(js.token); show($('#lOk'),'–ì–æ—Ç–æ–≤–æ!'); location.replace(nextUrl);
    }catch(err){ show($('#lErr'), err.message||'–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞') }
    finally{ setLoading($('#btnLogin'),false) }
  });

  // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (—Å —Ä–æ–ª—å—é)
  $('#showR').onclick = ()=>{ const p=$('#rPass'); p.type = p.type==='password'?'text':'password' };
  fReg.addEventListener('submit', async (e)=>{
    e.preventDefault(); hide($('#rErr')); hide($('#rOk')); setLoading($('#btnReg'),true,'–°–æ–∑–¥–∞—ë–º‚Ä¶');
    const name=$('#rName').value.trim(), email=$('#rEmail').value.trim(), pass=$('#rPass').value;
    const role = (document.querySelector('input[name="role"]:checked')?.value || 'buyer'); // buyer | master
    try{
      const rr = await fetch(api('/api/auth/register'), {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ name, email, password: pass, role })
      });
      const j = await rr.json().catch(()=>({}));
      if(!rr.ok || j.error) throw new Error(j.error || (rr.status===403?'–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω':'–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å'));

      // –∞–≤—Ç–æ–ª–æ–≥–∏–Ω
      const rl = await fetch(api('/api/auth/login'), {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ email, password: pass })
      });
      const jl = await rl.json().catch(()=>({}));
      if(!rl.ok || !jl.token) throw new Error(jl.error || '–ù–µ –≤–æ—à–ª–∏ –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏');

      saveToken(jl.token); show($('#rOk'),'–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω ‚úî'); location.replace(nextUrl);
    }catch(err){ show($('#rErr'), err.message||'–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏') }
    finally{ setLoading($('#btnReg'),false) }
  });

  // –ø—Ä–µ—Ñ–∏–ª–ª —Ä–æ–ª–∏/—Ñ–æ—Ä–º—ã –∏–∑ URL: ?mode=reg&role=master
  const usp = new URLSearchParams(location.search);
  if (usp.get('mode')==='reg') swap('reg');
  const qRole = usp.get('role');
  if (qRole==='buyer' || qRole==='master') {
    const rb = document.querySelector(`input[name="role"][value="${qRole}"]`);
    if (rb) rb.checked = true;
  }
})();
</script>
</body>
</html>
