<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Заявки — mebelplace</title>
<link rel="stylesheet" href="/common.css">
<style>
  :root{
    --bg:#0b0b0f; --panel:#11131a; --line:#232b3a; --muted:#9aa3b2; --text:#e5e7eb;
    --accent:#f59e0b; --danger:#ef4444; --ok:#10b981;
    --radius:16px; --hdr:56px; --tabbar-h:64px; --maxw:900px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Inter,Segoe UI,Roboto,Ubuntu}

  header{
    position:sticky;top:0;z-index:20;height:var(--hdr);
    display:flex;align-items:center;gap:10px;padding:0 16px;
    background:#0d0f15cc;border-bottom:1px solid var(--line);backdrop-filter:blur(8px)
  }
  .title{font-weight:900;font-size:22px}
  .spacer{flex:1}
  .btn{height:40px;padding:0 14px;border-radius:12px;border:1px solid var(--line);background:#121621;color:#e5e7eb;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#1b1304}
  .btn.ghost{background:#0b0d13}

  main{max-width:var(--maxw);margin:0 auto;padding:14px 14px calc(14px + var(--tabbar-h) + env(safe-area-inset-bottom))}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}

  .filters{display:flex;gap:8px;flex-wrap:wrap;margin:4px 0 10px;align-items:center}
  .chips{display:flex;gap:8px;flex-wrap:wrap}
  .chip{height:36px;padding:0 12px;border-radius:999px;border:1px solid #384158;background:#121827;color:#e5e7eb;font-weight:800;cursor:pointer}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#1b1304}

  /* combobox (searchable select) */
  .cbox{position:relative;min-width:260px}
  .cbox.in-filter{min-width:320px}
  .cbox-input{
    width:100%;min-height:36px;border-radius:999px;border:1px solid #384158;
    background:#121827;color:#e5e7eb;font-weight:700;padding:0 36px 0 12px;outline:none
  }
  .cbox-clear{
    position:absolute;right:34px;top:0;bottom:0;margin:auto;height:24px;width:24px;
    display:flex;align-items:center;justify-content:center;border:0;background:transparent;color:#9aa3b2;cursor:pointer
  }
  .cbox-arrow{
    position:absolute;right:6px;top:0;bottom:0;margin:auto;height:24px;width:24px;
    display:flex;align-items:center;justify-content:center;color:#9aa3b2;pointer-events:none
  }
  .cbox-list{
    position:absolute;left:0;right:0;top:calc(100% + 6px);z-index:30;
    background:#0f121b;border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow,0 10px 28px rgba(0,0,0,.35));
    max-height:280px;overflow:auto;padding:6px;display:none
  }
  .cbox.open .cbox-list{display:block}
  .cbox-opt{
    padding:8px 10px;border-radius:8px;display:flex;gap:8px;align-items:center;cursor:pointer
  }
  .cbox-opt:hover,.cbox-opt.active{background:#151c2b}
  .opt-code{font-weight:900;opacity:.9}
  .opt-name{flex:1}
  .opt-type{font-size:12px;color:#9aa3b2;border:1px solid #33405f;border-radius:999px;padding:2px 6px}

  .list{display:flex;flex-direction:column;gap:10px}
  .empty{border:1px dashed #2b364d;border-radius:12px;padding:22px;text-align:center;color:#9aa3b2}
  .item{
    display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:start;
    border:1px solid #2a344e;border-radius:12px;padding:12px;background:#121827
  }
  .thumb{width:84px;height:84px;object-fit:cover;border-radius:10px;border:1px solid #26314b;background:#0c1019}
  .noimg{width:84px;height:84px;border-radius:10px;border:1px dashed #2b364d;display:flex;align-items:center;justify-content:center;color:#556079;font-size:12px}
  .item h3{margin:0 0 6px;font-size:16px}
  .meta{font-size:12px;color:#9aa3b2}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .st{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid #33405f}
  .st.open{background:#182a22;border-color:#1f4d39;color:#a7f3d0}
  .st.wait{background:#2b2430;border-color:#4b3557;color:#e1c9ff}
  .st.closed{background:#2a1313;border-color:#803131;color:#fecaca}

  .sk{height:84px;border-radius:12px;border:1px solid var(--line);
      background:linear-gradient(90deg,#0f1420,#131b2a 45%,#0f1420 80%);background-size:200% 100%;animation:sh 1.1s infinite}
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}

  .sheet{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:flex-end;justify-content:center;z-index:50}
  .box{width:100%;max-width:var(--maxw);background:#0f121b;border:1px solid var(--line);border-radius:18px 18px 0 0;padding:16px;max-height:85vh;overflow:auto}
  .input{width:100%;min-height:44px;border-radius:12px;border:1px solid var(--line);background:#0b0d13;color:#e5e7eb;padding:10px 12px}
  textarea.input{min-height:96px;resize:vertical}
  .msg{display:none;margin:10px 0;padding:10px;border-radius:12px;font-size:14px}
  .ok{background:#072118;border:1px solid #0a3e2c;color:#a7f3d0}
  .err{background:#2a1313;border:1px solid #803131;color:#fecaca}

  .thread{display:flex;flex-direction:column;gap:10px;margin-top:10px}
  .reply{border:1px solid #2a344e;background:#0f1524;border-radius:12px;padding:10px}
  .reply .hdr{display:flex;gap:8px;align-items:center;justify-content:space-between}
  .reply .txt{margin-top:6px;color:#e5e7eb}
  .divider{height:1px;background:#1c2436;border:0;margin:10px 0}

  .tabbar{
    position:fixed;left:0;right:0;bottom:0;z-index:40;
    display:grid;grid-template-columns:repeat(5,1fr);
    height:var(--tabbar-h);background:#0b0b0f;border-top:1px solid var(--line);
    padding-bottom:env(safe-area-inset-bottom)
  }
  .tabbar a{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:13px;font-weight:800;color:#9ca3af;text-decoration:none}
  .tabbar a.active{color:#ffd28a}
  .tabbar a svg{color:currentColor}
</style>
</head>
<body>
<header>
  <div class="title">Мои заявки</div>
  <div class="spacer"></div>
  <button id="btnNew" class="btn primary">Новая</button>
</header>

<main>
  <div class="card">
    <div class="filters">
      <div class="chips" id="chips">
        <button class="chip active" data-filter="all">Все</button>
        <button class="chip" data-filter="open">Открытые</button>
        <button class="chip" data-filter="wait">В ожидании</button>
        <button class="chip" data-filter="closed">Закрытые</button>
      </div>
      <!-- фильтр по региону оставил, но цена везде удалена -->
      <div id="regionFilterBox" class="cbox in-filter" data-placeholder="Все регионы"></div>
    </div>

    <div id="list" class="list">
      <div class="sk"></div>
      <div class="sk"></div>
      <div class="sk"></div>
    </div>
  </div>
</main>

<nav class="tabbar" id="tabbar">
  <a href="/" data-path="/">
    <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3 2 12h3v9h6v-6h2v6h6v-9h3z"/></svg>
    <span>Лента</span>
  </a>
  <a href="/subs.html" data-path="/subs.html">
    <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0 -.62 .02 -.97 .05A6.1 6.1 0 0 1 18 16.5V19h6v-2.5C24 14.57 20.33 13 16 13z"/></svg>
    <span>Подписки</span>
  </a>
  <a href="/requests.html" data-path="/requests.html" class="active">
    <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M7 3h10a2 2 0 0 1 2 2v14l-7-3l-7 3V5a2 2 0 0 1 2-2z"/></svg>
    <span>Заявка всем</span>
  </a>
  <a href="/messenger.html" data-path="/messenger.html">
    <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/></svg>
    <span>Мессенджер</span>
  </a>
  <a href="/profile.html" data-path="/profile.html">
    <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14z"/></svg>
    <span>Профиль</span>
  </a>
</nav>

<!-- Sheet: новая заявка -->
<div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="newTitle">
  <div class="box">
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong id="newTitle">Новая заявка</strong>
      <button id="btnClose" class="btn">Закрыть</button>
    </div>

    <div id="mErr" class="msg err"></div>
    <div id="mOk"  class="msg ok"></div>

    <label class="muted" style="display:block;margin-top:8px">Заголовок</label>
    <input id="title" class="input" placeholder="Сделать кухню под ключ">

    <label class="muted" style="display:block;margin-top:8px">Описание</label>
    <textarea id="desc" class="input" placeholder="Размеры, материалы, сроки"></textarea>

    <div class="uploader" style="margin-top:10px">
      <img id="preview" class="preview" alt="превью" />
      <div>
        <label class="muted" style="display:block;margin-bottom:6px">Фото (jpg/png, до 8 МБ)</label>
        <input id="image" type="file" accept="image/*" class="input" style="padding:8px"/>
        <div class="meta" style="margin-top:6px">Добавьте фото — мастерам проще оценить заказ.</div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr;gap:12px;margin-top:8px">
      <div>
        <label class="muted" style="display:block">Регион (КЗ)</label>
        <div id="regionBox" class="cbox" data-placeholder="Выберите регион"></div>
      </div>
    </div>

    <div class="row" style="justify-content:flex-end;margin-top:12px">
      <button id="btnSave" class="btn primary">Создать</button>
    </div>
  </div>
</div>

<!-- Sheet: просмотр заявки + ответы -->
<div id="sheetView" class="sheet" role="dialog" aria-modal="true" aria-labelledby="viewTitle">
  <div class="box" id="viewBox"></div>
</div>

<script>
/* === РЕГИОНЫ КАЗАХСТАНА === */
const REGIONS_KZ = [
  {code:'01', name:'город Астана', type:'город республиканского значения'},
  {code:'02', name:'город Алматы', type:'город республиканского значения'},
  {code:'03', name:'Шымкент', type:'город республиканского значения'},
  {code:'04', name:'Актюбинская область', type:'область'},
  {code:'05', name:'Алматинская область', type:'область'},
  {code:'06', name:'Атырауская область', type:'область'},
  {code:'07', name:'Западно-Казахстанская область', type:'область'},
  {code:'08', name:'Жамбылская область', type:'область'},
  {code:'09', name:'Карагандинская область', type:'область'},
  {code:'10', name:'Костанайская область', type:'область'},
  {code:'11', name:'Кызылординская область', type:'область'},
  {code:'12', name:'Мангистауская область', type:'область'},
  {code:'13', name:'Туркестанская область', type:'область'},
  {code:'14', name:'Павлодарская область', type:'область'},
  {code:'15', name:'Северо-Казахстанская область', type:'область'},
  {code:'16', name:'Восточно-Казахстанская область', type:'область'},
  {code:'17', name:'Улытауская область', type:'область'},
  {code:'18', name:'Жетысуская область', type:'область'},
  {code:'19', name:'Абайская область', type:'область'},
  {code:'20', name:'Акмолинская область', type:'область'},
];

/* === УТИЛИТЫ === */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function tok(){ try{return localStorage.getItem('token')||''}catch{return''} }
function needAuth(){ if(!tok()) location.replace('/login.html?next=/requests.html') }
function hdr(json=true){ const h={}; const t=tok(); if(json) h['Content-Type']='application/json'; if(t) h['Authorization']='Bearer '+t; return h }
async function j(url,opts){
  opts=opts||{};
  const isForm = (opts.body instanceof FormData);
  const headers = Object.assign({}, hdr(!isForm), opts.headers||{});
  const r=await fetch(url,{method:opts.method||'GET',headers,body:isForm?opts.body:(opts.body?JSON.stringify(opts.body):undefined),credentials:'include'});
  const ct=r.headers.get('content-type')||''; const data=ct.includes('json')?await r.json().catch(()=>({})):{};
  if(!r.ok) throw new Error((data&&data.error)||('HTTP '+r.status));
  return data;
}
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])) }
(function navActive(){
  const cur = (location.pathname.replace(/\/+$/,'') || '/');
  $$('#tabbar a').forEach(a=>{
    const p=a.getAttribute('data-path'); const isHome=(p==='/'&&(cur==='/'||cur==='/index.html'));
    if(p===cur||isHome) a.classList.add('active');
  });
})();

/* === ГЛОБАЛЬНОЕ СОСТОЯНИЕ === */
const S = { all:[], filter:'all', regionFilter:null, me:null, role:null };

/* === Комбобокс === */
function makeCombobox(mount, items, opts={}){
  const placeholder = opts.placeholder || 'Выберите';
  const withAll = !!opts.withAll;
  mount.classList.add('cbox');

  mount.innerHTML = `
    <input class="cbox-input" type="text" placeholder="${placeholder}" aria-autocomplete="list" aria-expanded="false">
    <button class="cbox-clear" title="Очистить" aria-label="Очистить" hidden>×</button>
    <div class="cbox-arrow">▾</div>
    <div class="cbox-list" role="listbox"></div>
  `;
  const input = mount.querySelector('.cbox-input');
  const clearBtn = mount.querySelector('.cbox-clear');
  const list = mount.querySelector('.cbox-list');

  let value = null;
  let open = false;
  let actIdx = -1;
  const ALL_OPT = withAll ? [{code:'*', name:'Все регионы', type:''}] : [];
  const src = [...ALL_OPT, ...items];

  function norm(s){ return (s||'').toLowerCase().replace(/\s+/g,' ').trim(); }
  function match(q, it){
    if(it.code==='*') return true;
    const h = norm(q);
    if(!h) return true;
    const t = `${it.code} ${it.name} ${it.type}`.toLowerCase();
    return t.includes(h);
  }
  function renderList(q=''){
    const rows = src.filter(it=>match(q,it)).slice(0,50);
    list.innerHTML = rows.map((it,i)=>`
      <div class="cbox-opt${i===0?' active':''}" data-idx="${i}">
        <span class="opt-code">${it.code}</span>
        <span class="opt-name">${it.name}</span>
        ${it.type?`<span class="opt-type">${it.type}</span>`:''}
      </div>
    `).join('');
    actIdx = rows.length?0:-1;
  }
  function setOpen(v){
    open = v;
    mount.classList.toggle('open', open);
    input.setAttribute('aria-expanded', String(open));
    if(open){ renderList(input.value); }
  }
  function setValue(it){
    value = it && it.code!=='*' ? it : null;
    input.value = it ? (it.code==='*' ? 'Все регионы' : `${it.code} — ${it.name}`) : '';
    clearBtn.hidden = !it || it.code==='*';
    if(opts.onChange) opts.onChange(value);
  }

  setOpen(false);
  renderList('');

  input.addEventListener('focus', ()=>setOpen(true));
  input.addEventListener('click', ()=>setOpen(true));
  input.addEventListener('input', ()=>{ setOpen(true); renderList(input.value); });
  document.addEventListener('click', (e)=>{ if(!mount.contains(e.target)) setOpen(false); });

  list.addEventListener('mousemove', (e)=>{
    const opt = e.target.closest('.cbox-opt'); if(!opt) return;
    list.querySelectorAll('.cbox-opt').forEach(o=>o.classList.remove('active'));
    opt.classList.add('active'); actIdx = Number(opt.dataset.idx);
  });
  list.addEventListener('click', (e)=>{
    const opt = e.target.closest('.cbox-opt'); if(!opt) return;
    const rows = Array.from(list.querySelectorAll('.cbox-opt'));
    const idx = rows.indexOf(opt);
    const rowsData = src.filter(it=>match(input.value,it)).slice(0,50);
    const it = rowsData[idx];
    setValue(it);
    setOpen(false);
  });

  input.addEventListener('keydown', (e)=>{
    if(!open && (e.key==='ArrowDown'||e.key==='Enter')){ setOpen(true); e.preventDefault(); return; }
    const rows = Array.from(list.querySelectorAll('.cbox-opt'));
    if(!rows.length) return;
    if(e.key==='ArrowDown'){ actIdx = Math.min(actIdx+1, rows.length-1); updateAct(); e.preventDefault(); }
    if(e.key==='ArrowUp'){ actIdx = Math.max(actIdx-1, 0); updateAct(); e.preventDefault(); }
    if(e.key==='Enter'){ rows[actIdx]?.click(); e.preventDefault(); }
    if(e.key==='Escape'){ setOpen(false); }
    function updateAct(){
      rows.forEach(o=>o.classList.remove('active'));
      if(rows[actIdx]){ rows[actIdx].classList.add('active'); rows[actIdx].scrollIntoView({block:'nearest'}); }
    }
  });

  clearBtn.addEventListener('click', ()=>{ setValue(null); input.focus(); });

  return { get value(){ return value; }, clear(){ setValue(null); } };
}

/* === Профиль === */
async function loadMe(){ try{ const d=await j('/api/me'); S.me=d.user||null; S.role=S.me?.role||null; }catch{} }

/* === ПИЛЮЛЯ СТАТУСА === */
function stPill(s){
  const m={open:'Открыта',wait:'В ожидании',closed:'Закрыта'};
  const cls = ['st', (['open','wait','closed'].includes(s)?s:'open')].join(' ');
  return `<span class="${cls}">${m[s]||'Открыта'}</span>`;
}

/* === РЕНДЕР СПИСКА === */
function render(){
  const box = $('#list'); box.innerHTML='';
  const arr = S.all.filter(x=>{
    const byStatus = (S.filter==='all') ? true : ((x.status||'').toLowerCase()===S.filter);
    const rf = S.regionFilter;
    const byRegion = !rf ? true : (x.regionCode===rf.code);
    return byStatus && byRegion;
  });
  if(!arr.length){ box.innerHTML = `<div class="empty">Пока пусто</div>`; return; }

  arr.forEach(r=>{
    const el = document.createElement('div');
    el.className = 'item';
    const thumb = r.imageUrl ? `<img class="thumb" src="${r.imageUrl}" alt="">` : `<div class="noimg">без фото</div>`;
    const regionBadge = r.regionName ? `${r.regionCode||''} — ${r.regionName}` : (r.region || 'Регион не указан');
    el.innerHTML = `
      ${thumb}
      <div>
        <h3>${(r.title||'Заявка')}</h3>
        <div class="row" style="gap:8px">
          ${stPill((r.status||'open').toLowerCase())}
          <span class="badge">${regionBadge}</span>
          <span class="meta">${r.createdAt ? new Date(r.createdAt).toLocaleString() : ''}</span>
        </div>
        <div class="meta" style="margin-top:6px">${(r.preview||r.description||'').toString().slice(0,140)}</div>
      </div>
      <div class="row" style="justify-content:flex-end;min-width:160px">
        <button class="btn ghost" data-open="${encodeURIComponent(r.id)}">Открыть</button>
      </div>`;
    box.appendChild(el);
  });

  $$('#list [data-open]').forEach(b=>{
    b.onclick = () => openRequest(decodeURIComponent(b.getAttribute('data-open')));
  });
}

/* === ЗАГРУЗКА СПИСКА === */
async function load(){
  const box = $('#list');
  box.innerHTML = '<div class="sk"></div><div class="sk"></div><div class="sk"></div>';
  try{
    const data = await j('/api/requests');
    S.all = (data.items || data || []).map(x=>({
      id:x.id, title:x.title||'Заявка', description:x.description||'',
      preview:x.preview||'',
      regionCode:x.regionCode||x.region_code||null,
      regionName:x.regionName||x.region_name||null,
      region:x.region||null,
      imageUrl:x.imageUrl||x.image_url||'',
      status:(x.status||'open').toLowerCase(), createdAt:x.createdAt||x.created_at
    }));
  }catch(e){ S.all=[]; }
  render();
}

/* === СОЗДАНИЕ ЗАЯВКИ (без цены) === */
let regionCreate, regionFilter;
function openSheet(){ $('#sheet').style.display='flex'; $('#title').focus(); }
function closeSheet(){
  $('#sheet').style.display='none'; $('#mErr').style.display='none'; $('#mOk').style.display='none';
  $('#title').value=''; $('#desc').value='';
  regionCreate?.clear(); $('#image').value=''; $('#preview').src=''; $('#preview').style.display='none';
}
(function imagePreview(){
  const img = $('#image'); const prev = $('#preview'); prev.style.display='none';
  img?.addEventListener('change', ()=>{
    const f = img.files?.[0];
    if(!f){ prev.src=''; prev.style.display='none'; return; }
    if(f.size > 8*1024*1024){ $('#mErr').textContent='Файл слишком большой (макс. 8 МБ)'; $('#mErr').style.display='block'; img.value=''; prev.src=''; prev.style.display='none'; return; }
    const url = URL.createObjectURL(f); prev.src = url; prev.style.display='block';
  });
})();
async function save(){
  const t=$('#title').value.trim(), d=$('#desc').value.trim();
  const file = $('#image').files?.[0] || null;
  const reg = regionCreate.value; // {code,name}
  if(t.length<3){ const n=$('#mErr'); n.textContent='Слишком короткий заголовок'; n.style.display='block'; return }
  if(!reg){ const n=$('#mErr'); n.textContent='Выберите регион'; n.style.display='block'; return }
  $('#btnSave').disabled=true; $('#btnSave').textContent='Создаём…';
  try{
    const fd = new FormData();
    fd.append('title', t);
    fd.append('description', d);
    fd.append('regionCode', reg.code);
    fd.append('regionName', reg.name);
    fd.append('region', `${reg.code} — ${reg.name}`);
    if(file) fd.append('image', file);

    const headers = {}; const tkn=tok(); if(tkn) headers['Authorization']='Bearer '+tkn;
    await fetch('/api/requests',{method:'POST', headers, body: fd, credentials:'include'}).then(async res=>{
      const ct=res.headers.get('content-type')||''; const data=ct.includes('json')?await res.json().catch(()=>({})):{};
      if(!res.ok) throw new Error((data&&data.error)||('HTTP '+res.status));
      return data;
    });

    const ok=$('#mOk'); ok.textContent='Создано'; ok.style.display='block';
    setTimeout(()=>{ closeSheet(); load() }, 600);
  }catch(e){
    const er=$('#mErr'); er.textContent=e.message||'Ошибка'; er.style.display='block';
  }finally{
    $('#btnSave').disabled=false; $('#btnSave').textContent='Создать';
  }
}

/* === ПРОСМОТР ЗАЯВКИ (без цены) === */
function closeView(){ $('#sheetView').style.display='none'; $('#viewBox').innerHTML=''; }
async function openRequest(id){
  $('#sheetView').style.display='flex';
  const box = $('#viewBox');
  box.innerHTML = `
    <div class="row" style="justify-content:space-between;align-items:center">
      <strong id="viewTitle">Заявка</strong>
      <button id="btnCloseView" class="btn">Закрыть</button>
    </div>
    <div class="sk" style="height:140px;margin-top:10px"></div>
  `;
  $('#btnCloseView').onclick = closeView;

  try{
    const data = await j('/api/requests/'+encodeURIComponent(id));
    const r = {
      id: data.id, title: data.title||'Заявка', description: data.description||'',
      regionCode: data.regionCode||data.region_code||null,
      regionName: data.regionName||data.region_name||null,
      region: data.region||null,
      imageUrl: data.imageUrl||data.image_url||'',
      status: (data.status||'open').toLowerCase(),
      createdAt: data.createdAt||data.created_at,
      replies: data.replies||[]
    };
    const regionBadge = r.regionName ? `${r.regionCode||''} — ${r.regionName}` : (r.region || 'Регион не указан');
    const thumb = r.imageUrl ? `<img class="preview" style="width:100%;max-height:260px;object-fit:cover" src="${r.imageUrl}" alt="">` : '';

    box.innerHTML = `
      <div class="row" style="justify-content:space-between;align-items:center">
        <strong id="viewTitle">${r.title}</strong>
        <button id="btnCloseView" class="btn">Закрыть</button>
      </div>

      <div class="row" style="gap:8px;margin-top:8px">
        ${stPill(r.status)}
        <span class="badge">${regionBadge}</span>
        <span class="meta">${r.createdAt ? new Date(r.createdAt).toLocaleString() : ''}</span>
      </div>

      <div class="divider"></div>
      ${thumb}
      <p style="margin-top:10px">${r.description||'<span class="meta">без описания</span>'}</p>

      <div class="divider"></div>
      <h4 style="margin:6px 0 4px">Ответы мастеров</h4>
      <div id="thread" class="thread">
        ${r.replies.length? '' : '<div class="meta">Ответов пока нет</div>'}
        ${r.replies.map(rep => replyHtml(rep)).join('')}
      </div>

      <div class="divider"></div>
      <div id="replyWrap">
        <h4 style="margin:6px 0 8px">Оставить ответ</h4>
        <div class="row" style="gap:10px;flex-direction:column;align-items:stretch">
          <textarea id="replyText" class="input" placeholder="Опишите сроки, материалы, вопросы клиенту"></textarea>
          <button id="btnReply" class="btn primary" style="align-self:flex-start">Отправить</button>
          <div id="replyErr" class="msg err"></div>
        </div>
      </div>
    `;

    $('#btnCloseView').onclick = closeView;
    if(S.role && S.role!=='master'){ $('#replyWrap').style.display='none'; }

    $('#btnReply')?.addEventListener('click', async ()=>{
      const txt = $('#replyText').value.trim();
      if(txt.length<3){ showReplyErr('Слишком короткий ответ'); return; }
      try{
        $('#btnReply').disabled=true; $('#btnReply').textContent='Отправляем…';
        await j('/api/requests/'+encodeURIComponent(id)+'/replies', {
          method:'POST',
          body:{ text: txt } // цены нет
        });
        const now = new Date().toISOString();
        const fake = { id: 'tmp_'+Math.random().toString(36).slice(2),
          authorName: (S.me?.name||S.me?.username||'Мастер'),
          createdAt: now, text: txt };
        $('#thread').insertAdjacentHTML('afterbegin', replyHtml(fake));
        $('#replyText').value='';
        load();
      }catch(e){ showReplyErr(e.message||'Ошибка'); }
      finally{ $('#btnReply').disabled=false; $('#btnReply').textContent='Отправить'; }
    });

    function showReplyErr(msg){ const n=$('#replyErr'); n.textContent=msg; n.style.display='block'; setTimeout(()=>n.style.display='none', 3000); }

  }catch(e){
    const t = document.createElement('div');
    t.className='msg err'; t.textContent=e.message||'Ошибка загрузки'; t.style.display='block'; $('#viewBox').appendChild(t);
  }
}
function replyHtml(rep){
  const nm = rep.authorName || rep.author || 'Мастер';
  const when = rep.createdAt ? new Date(rep.createdAt).toLocaleString() : '';
  return `
    <div class="reply">
      <div class="hdr">
        <div class="row" style="gap:8px"><strong>${nm}</strong><span class="meta">${when}</span></div>
      </div>
      <div class="txt">${escapeHtml(rep.text||'')}</div>
    </div>
  `;
}

/* === ИНИТ === */
document.addEventListener('DOMContentLoaded', async ()=>{
  needAuth();
  await loadMe();

  // фильтр по статусу
  $$('#chips .chip').forEach(b=>{
    b.onclick=()=>{ $$('#chips .chip').forEach(x=>x.classList.remove('active')); b.classList.add('active'); S.filter=b.dataset.filter; render(); };
  });

  // комбобоксы
  regionFilter = makeCombobox($('#regionFilterBox'), REGIONS_KZ, {
    withAll:true, placeholder:'Все регионы',
    onChange:(val)=>{ S.regionFilter = val || null; render(); }
  });
  regionCreate = makeCombobox($('#regionBox'), REGIONS_KZ, {
    placeholder:'Начните ввод: код, название...',
  });

  await load();

  // модалки
  $('#btnNew').onclick=openSheet; $('#btnClose').onclick=closeSheet;
  $('#sheet').addEventListener('click',e=>{ if(e.target.id==='sheet') closeSheet() });
  $('#btnSave').onclick=save;

  $('#sheetView').addEventListener('click',e=>{ if(e.target.id==='sheetView') closeView() });
});
</script>
</body>
</html>
