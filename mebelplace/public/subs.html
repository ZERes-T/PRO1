<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Подписки — mebelplace</title>
<link rel="stylesheet" href="/common.css">
<style>
  :root{
    --bg:#0b0b0f; --panel:#11131a; --line:#232b3a; --muted:#9aa3b2; --text:#e5e7eb;
    --accent:#f59e0b; --danger:#ef4444;
    --radius:16px; --hdr:56px; --tabbar-h:64px; --maxw:900px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.5 system-ui,Inter,Segoe UI,Roboto,Ubuntu}
  a{color:inherit;text-decoration:none}

  /* Header */
  header{
    position:sticky;top:0;z-index:20;height:var(--hdr);
    display:flex;align-items:center;gap:10px;padding:0 16px;
    background:#0d0f15cc;border-bottom:1px solid var(--line);backdrop-filter:blur(8px)
  }
  .title{font-weight:900;font-size:22px}
  .spacer{flex:1}
  .btn{height:40px;padding:0 14px;border-radius:12px;border:1px solid var(--line);background:#121621;color:#e5e7eb;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:var(--accent);color:#1b1304}
  .btn.danger{background:#2a1313;border-color:#803131;color:#fecaca}

  /* Page */
  .page{max-width:var(--maxw);margin:0 auto;padding:14px 14px calc(14px + var(--tabbar-h) + env(safe-area-inset-bottom))}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}

  /* Controls */
  .controls{display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;margin-bottom:10px}
  .search{display:flex;gap:8px}
  .search input{
    flex:1;height:42px;border-radius:12px;border:1px solid var(--line);
    background:#0b0d13;color:#e5e7eb;padding:0 12px;outline:none
  }
  .filters{display:flex;gap:8px;flex-wrap:wrap}
  .chip{height:32px;padding:0 12px;border-radius:999px;border:1px solid #384158;background:#121827;color:#e5e7eb;font-weight:800;cursor:pointer;font-size:13px}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#1b1304}

  /* List */
  .list{display:flex;flex-direction:column;gap:10px}
  .empty{border:1px dashed #2b364d;border-radius:12px;padding:22px;text-align:center;color:#9aa3b2}
  .item{
    display:grid;grid-template-columns:auto 1fr auto;gap:12px;align-items:center;
    border:1px solid #2a344e;border-radius:12px;padding:10px;background:#121827
  }
  .ava{width:48px;height:48px;border-radius:50%;overflow:hidden;background:#141823}
  .ava img{width:100%;height:100%;object-fit:cover}
  .name{font-weight:900}
  .meta{font-size:12px;color:#9aa3b2}
  .right{display:flex;gap:8px;align-items:center}
  .sk{height:70px;border-radius:12px;border:1px solid var(--line);
      background:linear-gradient(90deg,#0f1420,#131b2a 45%,#0f1420 80%);background-size:200% 100%;animation:sh 1.1s infinite}
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* Bottom nav */
  .tabbar{
    position:fixed;left:0;right:0;bottom:0;z-index:40;
    display:grid;grid-template-columns:repeat(5,1fr);
    height:var(--tabbar-h);background:#0b0b0f;border-top:1px solid var(--line);
    padding-bottom:env(safe-area-inset-bottom)
  }
  .tabbar a{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:13px;font-weight:800;color:#9ca3af;text-decoration:none}
  .tabbar a.active{color:#ffd28a}
  .tabbar a svg{color:currentColor}

  @media (max-width: 780px){
    .controls{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <div class="title">Подписки</div>
  <div class="spacer"></div>
  <button id="btnDiscover" class="btn primary">Найти новых</button>
</header>

<div class="page">
  <div class="card">
    <div class="controls">
      <div class="search">
        <input id="q" placeholder="Поиск по имени или описанию" autocomplete="off">
      </div>
      <div class="filters" id="filters">
        <button class="chip active" data-filter="all">Все</button>
        <button class="chip" data-filter="masters">Мастера</button>
        <button class="chip" data-filter="companies">Компании</button>
        <button class="chip" data-sort="recent">С новыми постами</button>
      </div>
    </div>

    <div id="list" class="list">
      <div class="sk"></div>
      <div class="sk"></div>
      <div class="sk"></div>
    </div>
  </div>
</div>

<!-- bottom nav -->
<nav class="tabbar" id="tabbar">
  <a href="/" data-path="/">
    <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3 2 12h3v9h6v-6h2v6h6v-9h3z"/></svg>
    <span>Лента</span>
  </a>
  <a href="/subs.html" data-path="/subs.html" class="active">
    <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05A6.1 6.1 0 0 1 18 16.5V19h6v-2.5C24 14.57 20.33 13 16 13z"/></svg>
    <span>Подписки</span>
  </a>
  <a href="/requests.html" data-path="/requests.html">
    <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M7 3h10a2 2 0 0 1 2 2v14l-7-3l-7 3V5a2 2 0 0 1 2-2z"/></svg>
    <span>Заявка всем</span>
  </a>
  <a href="/messenger.html" data-path="/messenger.html">
    <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/></svg>
    <span>Мессенджер</span>
  </a>
  <a href="/profile.html" data-path="/profile.html">
    <svg width="22" height="22" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14z"/></svg>
    <span>Профиль</span>
  </a>
</nav>

<script>
/* utils */
const $ = s => document.querySelector(s);
const $$ = s => document.querySelectorAll(s);
function tok(){ try{return localStorage.getItem('token')||''}catch{return''} }
function needAuth(){ if(!tok()) location.replace('/login.html?next=/subs.html') }
function hdr(){ const h={'Content-Type':'application/json'}; const t=tok(); if(t) h['Authorization']='Bearer '+t; return h }
async function j(url,opts){ opts=opts||{}; const r=await fetch(url,{method:opts.method||'GET',headers:Object.assign({},hdr(),opts.headers||{}),body:opts.body?JSON.stringify(opts.body):undefined,credentials:'include'}); const ct=r.headers.get('content-type')||''; const data=ct.includes('json')?await r.json().catch(()=>({})):{}; if(!r.ok) throw new Error((data&&data.error)||('HTTP '+r.status)); return data }
function avatar(seed){ const s=encodeURIComponent(seed||'u'); return `<img src="https://api.dicebear.com/8.x/thumbs/svg?seed=${s}" alt="">`; }

/* bottom nav active */
(function(){
  const cur=(location.pathname.replace(/\/+$/,'')||'/');
  $$('#tabbar a').forEach(a=>{
    const p=a.getAttribute('data-path'); const isHome=(p==='/'&&(cur==='/'||cur==='/index.html'));
    if(p===cur||isHome) a.classList.add('active');
  });
})();

/* state */
const S={ all:[], filtered:[], filter:'all', sortRecent:false, q:'' };

/* render */
function itemNode(x){
  const el=document.createElement('div'); el.className='item'; el.dataset.id=x.id;
  el.innerHTML=`
    <div class="ava">${avatar(x.name||x.handle||x.id)}</div>
    <div>
      <div class="name">${x.name||x.handle||'Автор'}</div>
      <div class="meta">${x.category||'—'} • ${x.lastPostAt? ('Новый пост: ' + new Date(x.lastPostAt).toLocaleString()):'Постов пока нет'}</div>
    </div>
    <div class="right">
      <a class="btn" href="/profile.html?author=${encodeURIComponent(x.id)}">Открыть</a>
      <button class="btn danger" data-act="unsub">Отписаться</button>
    </div>`;
  el.querySelector('[data-act="unsub"]').onclick = ()=> confirmUnsub(x);
  return el;
}
function render(){
  const box=$('#list'); box.innerHTML='';
  let arr = S.all.slice();

  // фильтр по типу
  if(S.filter!=='all'){
    arr = arr.filter(x=> (x.type||'').toLowerCase()===S.filter);
  }
  // поиск
  if(S.q){
    const q=S.q.toLowerCase();
    arr = arr.filter(x=>(x.name||'').toLowerCase().includes(q) || (x.handle||'').toLowerCase().includes(q) || (x.category||'').toLowerCase().includes(q));
  }
  // сортировка по свежести постов
  if(S.sortRecent){
    arr.sort((a,b)=> (b.lastPostAt||0) - (a.lastPostAt||0));
  }else{
    arr.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
  }

  if(!arr.length){ box.innerHTML = `<div class="empty">Подписок пока нет</div>`; return; }
  arr.forEach(x=> box.appendChild(itemNode(x)));
}

/* api */
async function load(){
  const box=$('#list'); box.innerHTML='<div class="sk"></div><div class="sk"></div><div class="sk"></div>';
  try{
    // ожидаем {items:[{id,name,handle,category,type,lastPostAt}]}
    const data = await j('/api/subs');
    S.all = (data.items||data||[]).map(x=>({
      id:x.id, name:x.name||x.title||x.handle||'',
      handle:x.handle||'', category:x.category||'',
      type:(x.type||'masters').toLowerCase(), // masters / companies
      lastPostAt:x.lastPostAt||x.last_post_at||null
    }));
  }catch(e){ S.all=[]; }
  render();
}
async function unsub(id){
  try{ await j(`/api/subs/${encodeURIComponent(id)}`, {method:'DELETE'}); S.all = S.all.filter(x=>x.id!==id); render(); }
  catch(e){ alert(e.message||'Не удалось отписаться'); }
}

/* actions */
function confirmUnsub(x){
  if(confirm(`Отписаться от «${x.name||x.handle}»?`)){ unsub(x.id); }
}

/* init */
document.addEventListener('DOMContentLoaded', ()=>{
  needAuth(); load();

  // поиск
  $('#q').addEventListener('input', e=>{ S.q=e.target.value.trim(); render(); });

  // фильтры
  $$('#filters .chip').forEach(ch=>{
    const f=ch.dataset.filter; const s=ch.dataset.sort;
    ch.onclick=()=>{
      if(f){ S.filter=f; $$('#filters .chip[data-filter]').forEach(x=>x.classList.remove('active')); ch.classList.add('active'); }
      if(s){ S.sortRecent = !S.sortRecent; ch.classList.toggle('active', S.sortRecent); }
      render();
    };
  });

  // открыть каталог новых (переход на твою страницу/роут)
  $('#btnDiscover').onclick = ()=> location.href = '/discover.html';
});
</script>
</body>
</html>
