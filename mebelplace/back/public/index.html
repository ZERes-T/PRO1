<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>mebelplace ‚Äî –õ–µ–Ω—Ç–∞</title>
<link rel="stylesheet" href="/common.css">
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8"></script>
<style>
  :root{
    --header-h:56px;
    --tabbar-h:64px;             /* –Ω–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
    --stage-w: clamp(320px, 36vw, 640px);
    --shell-max:1280px;
    --line: rgba(255,255,255,.08);
    --stage-h: 600px;            /* –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è JS */
  }
  *{box-sizing:border-box}
  html,body{height:100%;background:#000;color:#fff}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",sans-serif}
  a{color:inherit;text-decoration:none}

  /* header */
  header{
    position:sticky;top:0;z-index:70;height:var(--header-h);
    display:flex;align-items:center;gap:12px;padding:0 12px;
    background:#0b0b0b;border-bottom:1px solid var(--line)
  }
  .brand{font-weight:900}
  .grow{flex:1}
  .btn{height:36px;padding:0 12px;border-radius:10px;border:1px solid #23262d;background:#121418;color:#fff;cursor:pointer}
  .btn:hover{background:#161a20}

  /* SEARCH BAR */
  .searchbar{
    position:sticky; top:var(--header-h); z-index:60;
    background:#0b0b0b; border-bottom:1px solid var(--line);
    padding:10px 12px;
  }
  .search-row{max-width:var(--shell-max); margin:0 auto; display:grid; grid-template-columns: 1fr var(--stage-w) 1fr; gap:24px}
  .search{grid-column:2; position:relative}
  .search input{
    width:100%; height:40px; border-radius:12px; border:1px solid #23262d;
    background:#121418; color:#e5e7eb; padding:0 40px 0 38px; font-weight:700; outline:none
  }
  .search .icon{position:absolute;left:10px;top:0;bottom:0;display:grid;place-items:center;opacity:.7}
  .search .clear{
    position:absolute;right:6px;top:0;bottom:0;margin:auto;height:28px;width:28px;
    display:grid;place-items:center;border:0;border-radius:8px;background:#1a1d23;color:#cbd5e1;cursor:pointer
  }
  .search .clear[hidden]{display:none}

  .sugg{grid-column:2;margin-top:8px;display:none;gap:8px;flex-wrap:wrap}
  .sugg.show{display:flex}
  .chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 10px;border-radius:999px;border:1px solid #2a2f3a;background:#121418;
    color:#e5e7eb;font-weight:800;font-size:13px;cursor:pointer
  }
  .chip:hover{background:#161b22}

  /* layout */
  .shell{max-width:var(--shell-max); margin:0 auto; display:grid; grid-template-columns: 1fr var(--stage-w) 1fr; gap:24px;}
  .stage{position:relative;height:var(--stage-h);overflow:hidden}
  .track{height:100%;display:flex;flex-direction:column;transition:transform .28s ease;will-change:transform}
  .slide{
    position:relative;flex:0 0 auto;height:var(--stage-h);
    display:grid;place-items:center;overflow:hidden
  }

  .frame{
    position:relative;height:100%;width:auto;aspect-ratio:9/16;max-width:100%;
    border-radius:18px;overflow:hidden;background:#000;border:1px solid var(--line);
    box-shadow:0 20px 60px rgba(0,0,0,.5)
  }
  .frame video{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;background:#000}

  .meta{position:absolute;left:14px;right:110px;bottom:14px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.5);z-index:3}
  .title{font-size:16px;font-weight:900}
  .tags{margin-top:6px;font-size:13px;color:#e5e7eb;display:flex;gap:6px;flex-wrap:wrap}
  .tag{padding:2px 8px;border-radius:999px;border:1px solid #334155;background:#0c1118;color:#e5e7eb;font-weight:800;cursor:pointer}
  .tag:hover{background:#121a26}

  .progress{position:absolute;left:0;right:0;bottom:0;height:3px;background:rgba(255,255,255,.22)}
  .bar{height:100%;width:0;background:#fff}

  .stack{position:absolute;right:10px;bottom:20px;z-index:4;display:flex;flex-direction:column;align-items:center;gap:16px}
  .pill{width:58px;height:58px;border-radius:999px;display:grid;place-items:center;border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.92);color:#0f172a;font-size:22px;cursor:pointer;user-select:none;box-shadow:0 10px 30px rgba(0,0,0,.3)}
  .pill:active{transform:scale(.98)}
  .pill.like.hearted{background:#f43f5e;color:#fff;border-color:#f43f5e}
  .count{color:#fff;font-weight:800;font-size:12px;text-shadow:0 2px 10px rgba(0,0,0,.6);margin-top:2px}
  .avatar{position:relative;width:64px;height:64px;border-radius:999px;border:2px solid #fff;overflow:hidden;box-shadow:0 12px 28px rgba(0,0,0,.4)}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .disc{width:48px;height:48px;border-radius:999px;border:2px solid #fff;overflow:hidden;animation:spin 4s linear infinite}
  .disc img{width:100%;height:100%;object-fit:cover}
  @keyframes spin{to{transform:rotate(360deg)}}

  .unmute{position:absolute;left:12px;bottom:70px;z-index:5;display:flex;align-items:center;gap:8px;padding:10px 12px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.18);backdrop-filter:blur(6px);border-radius:12px;font-weight:700}
  .unmute.hide{display:none}

  .skeleton{
    width:100%;height:100%;border-radius:18px;
    background:
      linear-gradient(#0b0b0b,#0b0b0b) padding-box,
      linear-gradient(90deg,#111319,#1b1f2b 20%,#111319 40%) border-box;
    border:1px solid transparent;background-size:200% 100%;animation:sh 1.1s infinite
  }
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .error{position:absolute;left:0;right:0;top:40%;text-align:center;color:#e11d48}

  /* –Ω–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
  .tabbar{
    position:fixed;left:0;right:0;bottom:0;z-index:55;
    display:grid;grid-template-columns:repeat(5,1fr);
    height:var(--tabbar-h);background:#0b0b0b;border-top:1px solid var(--line);
    padding-bottom:env(safe-area-inset-bottom)
  }
  .tabbar a{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:13px;font-weight:800;color:#9ca3af;text-decoration:none}
  .tabbar a.active{color:#f59e0b}
  .tabbar a svg{color:currentColor}

  /* –º–æ–±–∏–ª—å–Ω—ã–µ */
  @media (max-width: 768px){
    .shell{display:block}
    .search-row{grid-template-columns: 12px 1fr 12px}
    .search{grid-column:2}
    .frame{width:100vw;height:auto;aspect-ratio:9/16;border:none;box-shadow:none;border-radius:0;max-width:100vw}
    .stack{right:8px;bottom:86px}
    .unmute{left:8px;bottom:86px}
    .meta{left:10px;right:74px;bottom:10px}
  }
  @media (min-width: 1400px){ :root{ --stage-w: clamp(360px, 32vw, 720px); } }
  @media (prefers-reduced-motion: reduce){ .track{transition:none} .disc{animation:none} }
</style>
</head>
<body>
<header>
  <div class="brand">mebelplace</div>
  <div class="grow"></div>
  <button id="btnRefresh" class="btn">–û–±–Ω–æ–≤–∏—Ç—å</button>
</header>

<!-- –ø–æ–∏—Å–∫ -->
<div class="searchbar">
  <div class="search-row">
    <div></div>
    <div class="search">
      <span class="icon">üîé</span>
      <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫: –≤–∏–¥–µ–æ –∏–ª–∏ #—Ç–µ–≥">
      <button id="qClear" class="clear" hidden>√ó</button>
    </div>
    <div></div>

    <!-- –ø–æ–¥—Å–∫–∞–∑–∫–∏-—Ç–µ–≥–∏ -->
    <div id="sugg" class="sugg"></div>
  </div>
</div>

<main class="shell">
  <div></div>
  <section class="stage" id="stage">
    <div class="track" id="track">
      <div class="slide"><div class="frame"><div class="skeleton"></div></div></div>
    </div>
    <div id="err" class="error" style="display:none"></div>
  </section>
  <div></div>
</main>

<!-- –ù–ò–ñ–ù–Ø–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø -->
<nav class="tabbar" id="tabbar">
  <a href="/" data-path="/">
    <svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M12 3 2 12h3v9h6v-6h2v6h6v-9h3z"/></svg>
    <span>–õ–µ–Ω—Ç–∞</span>
  </a>
  <a href="/subs.html" data-path="/subs.html">
    <svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13zm8 0c-.29 0-.62.02-.97.05A6.1 6.1 0 0 1 18 16.5V19h6v-2.5C24 14.57 20.33 13 16 13z"/></svg>
    <span>–ü–æ–¥–ø–∏—Å–∫–∏</span>
  </a>
  <a href="/requests.html" data-path="/requests.html">
    <svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M7 3h10a2 2 0 0 1 2 2v14l-7-3l-7 3V5a2 2 0 0 1 2-2z"/></svg>
    <span>–ó–∞—è–≤–∫–∞ –≤—Å–µ–º</span>
  </a>
  <a href="/messenger.html" data-path="/messenger.html">
    <svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M20 2H4a2 2 0 0 0-2 2v18l4-4h14a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2z"/></svg>
    <span>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</span>
  </a>
  <a href="/profile.html" data-path="/profile.html">
    <svg width="26" height="26" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14z"/></svg>
    <span>–ü—Ä–æ—Ñ–∏–ª—å</span>
  </a>
</nav>

<script>
/* –∞–∫—Ç–∏–≤–Ω–æ–µ –¥–Ω–æ-–º–µ–Ω—é */
(() => {
  const cur = (location.pathname.replace(/\/+$/,'') || '/');
  document.querySelectorAll('#tabbar a').forEach(a=>{
    const p=a.getAttribute('data-path');
    const isHome=(p==='/'&&(cur==='/'||cur==='/index.html'));
    a.classList.toggle('active', isHome || p===cur);
  });
})();
</script>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const stage = $('#stage'), track = $('#track'), errBox = $('#err'), tabbar = $('#tabbar');
  const qInput = $('#q'), qClear = $('#qClear'), suggBox = $('#sugg');

  const state = { items:[], view:[], index:0, height:0, lock:false, tagsIndex:[] };
  let soundUnlocked = (localStorage.getItem('mp_sound') === 'on');

  const esc = s => String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const avatarUrl = id => `https://api.dicebear.com/8.x/thumbs/svg?seed=${encodeURIComponent(id||'mebel')}`;
  const posterUrl = id => `https://api.dicebear.com/8.x/identicon/svg?seed=${encodeURIComponent(id||'mebel')}`;
  const fmtCount = n => { n=Number(n||0); if(n>=1_000_000) return (n/1_000_000).toFixed(1).replace('.0','')+' –º–ª–Ω.'; if(n>=1000) return (n/1000).toFixed(1).replace('.0','')+' —Ç—ã—Å.'; return String(n) };

  /* –≤—ã—Å–æ—Ç–∞ —Å—Ü–µ–Ω—ã —Å —É—á—ë—Ç–æ–º —Ç–∞–±–±–∞—Ä–∞ –∏ –ø–æ–∏—Å–∫–∞ */
  function setStageHeight(){
    const vv = window.visualViewport;
    const vh = Math.round(vv ? vv.height : window.innerHeight);
    const top = Math.round(stage.getBoundingClientRect().top);
    const tabH = tabbar?.offsetHeight || 0;
    const safe = (parseInt(getComputedStyle(tabbar).paddingBottom) || 0);
    const h = Math.max(320, vh - top - tabH + safe);
    document.documentElement.style.setProperty('--stage-h', h + 'px');
    state.height = h;
    track.style.transform = `translate3d(0, ${-state.index*h}px, 0)`;
  }
  addEventListener('resize', setStageHeight, {passive:true});
  addEventListener('orientationchange', setStageHeight, {passive:true});
  if (window.visualViewport) window.visualViewport.addEventListener('resize', setStageHeight, {passive:true});

  /* utils: —Ç–µ–≥–∏/–ø–æ–∏—Å–∫ */
  const splitTags = s => (String(s||'').split(/\s+/).filter(Boolean).filter(w=>w.startsWith('#')).map(w=>w.toLowerCase()));
  function buildTagsIndex(items){
    const m = new Map();
    for(const it of items){
      for(const t of splitTags(it.tags)){ m.set(t, (m.get(t)||0)+1); }
    }
    return Array.from(m, ([tag,count])=>({tag,count})).sort((a,b)=>b.count-a.count);
  }
  function tokens(q){
    const arr = String(q||'').trim().toLowerCase().split(/\s+/).filter(Boolean);
    const tags = arr.filter(x=>x.startsWith('#'));
    const terms = arr.filter(x=>!x.startsWith('#'));
    return {tags, terms};
  }
  function matchItem(it, q){
    const t = tokens(q);
    if(!t.tags.length && !t.terms.length) return true;
    const title = (it.title||'').toLowerCase();
    const tagsArr = splitTags(it.tags);
    // –≤—Å–µ –∑–∞–ø—Ä–æ—à–µ–Ω–Ω—ã–µ —Ç–µ–≥–∏ –¥–æ–ª–∂–Ω—ã –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–æ–≤–∞—Ç—å
    for(const tag of t.tags){ if(!tagsArr.includes(tag)) return false; }
    // –≤—Å–µ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ç–µ—Ä–º–∏–Ω—ã –¥–æ–ª–∂–Ω—ã –≤—Å—Ç—Ä–µ—á–∞—Ç—å—Å—è –≤ title –∏–ª–∏ –≤ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –≤–∏–¥–µ —Ç–µ–≥–æ–≤
    const tagsPlain = tagsArr.map(x=>x.replace(/^#/,'')).join(' ');
    for(const term of t.terms){
      if(!(title.includes(term) || tagsPlain.includes(term))) return false;
    }
    return true;
  }

  function applyFilter(q){
    const view = state.items.filter(it=>matchItem(it,q));
    state.view = view;
    state.index = 0;
    renderAll();
    // –æ–±–Ω–æ–≤–∏–º URL (–±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏)
    const url = new URL(location.href);
    if(q) url.searchParams.set('q', q); else url.searchParams.delete('q');
    history.replaceState(null,'',url.toString());
  }

  function updateSugg(q){
    const {tags} = tokens(q);
    let list = state.tagsIndex;
    if(tags.length){ const p = tags[tags.length-1]; list = list.filter(x=>x.tag.startsWith(p)); }
    list = list.slice(0, 12);
    suggBox.innerHTML = list.map(x=>`<button class="chip" data-tag="${x.tag}">${x.tag}<span style="opacity:.7;font-weight:700"> ${x.count}</span></button>`).join('');
    suggBox.classList.toggle('show', list.length>0);
    setStageHeight(); // —á—Ç–æ–±—ã —Å—Ü–µ–Ω–∞ —Ç–æ—á–Ω–æ —É—á–∏—Ç—ã–≤–∞–ª–∞ –≤—ã—Å–æ—Ç—É –ø–æ–¥—Å–∫–∞–∑–æ–∫
  }

  function setQuery(q){
    qInput.value = q;
    qClear.hidden = !q;
    updateSugg(q);
    applyFilter(q);
  }

  /* HLS attach */
  function attachHLS(videoEl, src){
    if(!src) return;
    if(src.endsWith('.m3u8')){
      if (window.Hls && window.Hls.isSupported()){
        const h = new window.Hls({maxBufferLength:24, enableWorker:true});
        h.loadSource(src); h.attachMedia(videoEl);
      } else if (videoEl.canPlayType('application/vnd.apple.mpegURL')) {
        videoEl.src = src;
      } else {
        videoEl.src = src;
      }
    } else { videoEl.src = src; }
  }

  function tagsHTML(s){
    const arr = splitTags(s);
    if(!arr.length) return '';
    return arr.map(t=>`<button class="tag" data-tag="${t}">${t}</button>`).join('');
  }

  function makeSlide(v, idx){
    const slide = document.createElement('div'); slide.className='slide';
    const frame = document.createElement('div'); frame.className='frame';
    const vid = document.createElement('video');
    vid.setAttribute('playsinline',''); vid.setAttribute('webkit-playsinline','');
    vid.muted = !soundUnlocked; vid.loop = true; vid.autoplay = false; vid.preload='metadata';
    vid.poster = v.poster || posterUrl(v.owner_id||idx);
    attachHLS(vid, v.url);
    frame.appendChild(vid);

    const unmute = document.createElement('div');
    unmute.className = 'unmute' + (vid.muted?'':' hide');
    unmute.innerHTML = 'üîä <span>–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–≤—É–∫–∞</span>';
    frame.appendChild(unmute);

    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `<div class="title">${esc(v.title||'–í–∏–¥–µ–æ')}</div><div class="tags">${tagsHTML(v.tags||'')}</div>`;
    frame.appendChild(meta);

    const prog = document.createElement('div'); prog.className='progress';
    const bar = document.createElement('div'); bar.className='bar';
    prog.appendChild(bar); frame.appendChild(prog);
    vid.addEventListener('timeupdate', ()=>{ if(vid.duration>0){ bar.style.width = ((vid.currentTime/vid.duration)*100).toFixed(2)+'%'; } });

    const stack = document.createElement('div'); stack.className='stack';
    const av = document.createElement('div'); av.className='avatar'; av.innerHTML = `<img src="${avatarUrl(v.owner_id||idx)}" alt="">`; stack.appendChild(av);
    const like = document.createElement('button'); like.className='pill like'; like.title='–õ–∞–π–∫'; like.textContent='‚ù§';
    const likeCnt = document.createElement('div'); likeCnt.className='count'; likeCnt.textContent = fmtCount(v.likes||0);
    like.onclick = e=>{ e.stopPropagation(); like.classList.toggle('hearted'); };
    stack.appendChild(like); stack.appendChild(likeCnt);
    const comm = document.createElement('button'); comm.className='pill'; comm.title='–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏'; comm.textContent='üí¨';
    const commCnt = document.createElement('div'); commCnt.className='count'; commCnt.textContent = fmtCount(v.comments||0);
    comm.onclick = e=>{ e.stopPropagation(); alert('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ–∫–∞ –æ—Ñ—Ñ'); };
    stack.appendChild(comm); stack.appendChild(commCnt);
    const share = document.createElement('button'); share.className='pill'; share.title='–ü–æ–¥–µ–ª–∏—Ç—å—Å—è'; share.textContent='‚Üó';
    share.onclick = async e=>{
      e.stopPropagation();
      const url = location.origin+'/?v='+encodeURIComponent(v.id);
      if(navigator.share){ try{ await navigator.share({title:v.title||'–í–∏–¥–µ–æ', url}) }catch{} }
      else { try{ await navigator.clipboard.writeText(url); alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞') }catch{ prompt('–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É:', url) } }
    };
    stack.appendChild(share);
    const disc = document.createElement('div'); disc.className='disc'; disc.innerHTML = `<img src="${v.poster || posterUrl(v.owner_id||idx)}" alt="">`; stack.appendChild(disc);
    frame.appendChild(stack);

    // tag click (–¥–µ–ª–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ)
    frame.addEventListener('click', e=>{
      const t = e.target.closest('[data-tag]');
      if(t){ e.stopPropagation(); setQuery(t.dataset.tag); }
    });

    // –≤–∏–¥–∏–º–æ—Å—Ç—å ‚Äî –∞–≤—Ç–æ–∑–≤—É–∫/–ø–∞—É–∑–∞
    if (slide._io) slide._io.disconnect();
    slide._io = new IntersectionObserver((ents)=>{
      for(const ent of ents){
        if(ent.isIntersecting && ent.intersectionRatio>=0.75){
          vid.muted = !soundUnlocked; playSafe(vid); prewarmNext();
        } else { vid.pause(); }
      }
    }, {threshold:[0,0.75], root:stage});
    slide._io.observe(slide);

    // –∂–µ—Å—Ç: –ø–µ—Ä–≤—ã–π –∫–ª–∏–∫ ‚Äî –≤–∫–ª—é—á–∏—Ç—å –∑–≤—É–∫
    let firstGestureDone = soundUnlocked;
    frame.addEventListener('click', ()=>{
      if(!firstGestureDone){
        firstGestureDone=true; soundUnlocked=true;
        vid.muted=false; localStorage.setItem('mp_sound','on');
        unmute.classList.add('hide'); playSafe(vid); return;
      }
      vid.paused ? playSafe(vid) : vid.pause();
    });

    slide._video = vid;
    slide.appendChild(frame);
    return slide;
  }

  function playSafe(vid){ try{ const p=vid.play(); if(p?.catch) p.catch(()=>{}); }catch{} }
  function prewarmNext(){
    const slides=[...track.children]; const next=slides[state.index+1]; const vid=next?._video; if(!vid) return;
    try{ vid.preload='auto'; if(vid.readyState<2) vid.load(); }catch{}
  }

  /* –Ω–∞–≤–∏–≥–∞—Ü–∏—è */
  function step(dir){
    if(state.lock) return;
    const slides=[...track.children];
    const next = Math.max(0, Math.min(slides.length-1, state.index+dir));
    if(next===state.index) return;
    state.lock = true;
    slides[state.index]?._video?.pause();
    state.index = next;
    track.style.transform = `translate3d(0, ${-state.index*state.height}px, 0)`;
    setTimeout(()=>{ state.lock=false; const cur=slides[state.index]?._video; if(cur){ cur.muted=!soundUnlocked; playSafe(cur); } prewarmNext(); }, 280);
  }

  let wheelAccum=0, wheelT=null;
  stage.addEventListener('wheel', e=>{
    e.preventDefault(); wheelAccum+=e.deltaY; clearTimeout(wheelT);
    wheelT=setTimeout(()=>{ if(Math.abs(wheelAccum)>30){ step(wheelAccum>0?+1:-1); wheelAccum=0 } }, 40);
  }, {passive:false});
  let tsY=0, tmv=0;
  stage.addEventListener('touchstart', e=>{ tsY=e.touches[0].clientY; tmv=0 }, {passive:true});
  stage.addEventListener('touchmove',  e=>{ tmv=e.touches[0].clientY - tsY }, {passive:true});
  stage.addEventListener('touchend',   ()=>{ if(Math.abs(tmv)>40) step(tmv<0?+1:-1); tmv=0; tsY=0 });
  addEventListener('keydown', e=>{
    if(e.target.closest('input,textarea')) return;
    if(e.key==='ArrowDown' || e.key==='PageDown') step(+1);
    if(e.key==='ArrowUp'   || e.key==='PageUp')   step(-1);
    if(e.code==='Space'){ const cur=track.children[state.index]?._video; if(cur){ cur.paused?playSafe(cur):cur.pause(); e.preventDefault(); } }
    if(e.key==='Escape'){ setQuery(''); }
  });

  /* —Ä–µ–Ω–¥–µ—Ä */
  function appendOne(v,i){
    const el = makeSlide(v,i);
    track.appendChild(el);
    if(i===0){ setStageHeight(); requestAnimationFrame(()=>{ el._video && playSafe(el._video); prewarmNext(); }) }
  }
  function renderAll(){
    track.innerHTML='';
    if(!state.view.length){
      track.innerHTML = '<div class="slide"><div class="frame"><div class="error">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></div></div>';
      setStageHeight(); return;
    }
    state.view.forEach((it,i)=>appendOne(it,i));
    setStageHeight();
  }

  /* –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∏–¥–∞ */
  async function loadFeed(){
    track.innerHTML = '<div class="slide"><div class="frame"><div class="skeleton"></div></div></div>'; errBox.style.display='none';
    try{
      const r = await fetch('/api/media.php',{credentials:'include'}); if(!r.ok) throw new Error('HTTP '+r.status);
      const j = await r.json(); const files = Array.isArray(j)?j:(j.items||[]);
      if(!files.length){ errBox.textContent='–í–∏–¥–µ–æ –ø–æ–∫–∞ –Ω–µ—Ç.'; errBox.style.display='block'; return; }
      state.items = files.map((it,i)=>({ id:it.id||(1000+i), title:it.title||('–í–∏–¥–µ–æ '+(i+1)), url:it.url, poster:it.poster||null, owner_id:it.owner_id||i, likes:it.likes||0, comments:it.comments||0, shares:it.shares||0, tags:it.tags||'#–º–µ–±–µ–ª—å #–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ #–º–∞—Å—Ç–µ—Ä—Å–∫–∞—è' }));
      state.tagsIndex = buildTagsIndex(state.items);
      // —Å—Ç–∞—Ä—Ç–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ q –∏–∑ URL
      const url = new URL(location.href); const q = url.searchParams.get('q') || '';
      state.view = state.items.slice();
      setQuery(q);
      updateSugg(q);
    }catch(e){ errBox.textContent='–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–µ–Ω—Ç—É. –ü—Ä–æ–≤–µ—Ä—å API /api/media.php'; errBox.style.display='block'; console.error(e); }
  }

  /* –ø–æ–∏—Å–∫: –∏–Ω–ø—É—Ç, –æ—á–∏—Å—Ç–∫–∞, –ø–æ–¥—Å–∫–∞–∑–∫–∏, –∫–ª–∏–∫ –ø–æ —Ç–µ–≥—É */
  const debounce = (fn,ms)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a),ms); } };
  qInput.addEventListener('input', debounce(()=>{ qClear.hidden = !qInput.value.trim(); updateSugg(qInput.value); applyFilter(qInput.value); }, 120));
  qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); applyFilter(qInput.value); } });
  qClear.addEventListener('click', ()=> setQuery(''));
  suggBox.addEventListener('click', e=>{
    const b = e.target.closest('[data-tag]'); if(!b) return;
    setQuery(b.dataset.tag);
  });

  document.getElementById('btnRefresh').addEventListener('click', loadFeed);
  addEventListener('load', ()=>{ setStageHeight(); loadFeed(); });
})();
</script>
</body>
</html>
