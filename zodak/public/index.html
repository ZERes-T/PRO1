<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Лента — mebelplace</title>
<link rel="stylesheet" href="/common.css">
<script src="/domain-notice.js" defer></script>
<style>
  :root{ --navh:96px; --shadow:0 8px 24px rgba(0,0,0,.16); --dockw:380px; --line:#e5e7eb }

  html,body{height:100%;background:#000;color:#fff}
  header{background:#fff;color:#0f172a;border-bottom:1px solid var(--line)}
  .brand{font-weight:800}
  @media(max-width:768px){ header{display:none} }

  main{padding:0;margin:0}
  .wrap{position:relative}
  .feed{position:relative;height:calc(100dvh - var(--navh));overflow:hidden;touch-action:none;background:#000}
  @media(min-width:1024px){ .feed{margin-right:var(--dockw)} .chat-dock{display:flex} }

  /* шаговая прокрутка */
  .feed-inner{height:100%;display:flex;flex-direction:column;transform:translate3d(0,0,0);transition:transform 320ms ease}
  .slide{position:relative;height:calc(100dvh - var(--navh));flex:0 0 auto;background:#000}
  .video{position:absolute;inset:0}
  .video video{width:100%;height:100%;object-fit:cover;background:#000}

  /* верхняя панель */
  .topbar{position:absolute;left:0;right:0;top:0;height:56px;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;text-shadow:0 1px 10px rgba(0,0,0,.5);pointer-events:none}
  .tabs{display:flex;gap:24px}
  .tabs span{opacity:.65}
  .tabs .active{opacity:1;position:relative}
  .tabs .active::after{content:"";position:absolute;left:0;right:0;bottom:-6px;height:3px;border-radius:3px;background:#fff}

  /* правый столбик — TikTok */
  .stack{position:absolute;right:12px;bottom:110px;display:flex;flex-direction:column;gap:14px;align-items:center;z-index:3}
  @media(min-width:1024px){ .stack{bottom:96px} }
  .circle{width:62px;height:62px;border-radius:999px;display:grid;place-items:center;background:rgba(255,255,255,.96);border:1px solid #e6e7ee;box-shadow:var(--shadow);color:#0f172a;font-size:24px;user-select:none;-webkit-tap-highlight-color:transparent}
  .circle:active{transform:scale(.98)}
  .count{color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.6);font-weight:800;font-size:12px;margin-top:2px}
  .like.hearted{background:#f43f5e;border-color:#f43f5e;color:#fff}
  .avatar{position:relative;border-radius:999px;overflow:hidden;width:66px;height:66px;border:2px solid #fff;box-shadow:var(--shadow)}
  .avatar img{width:100%;height:100%;object-fit:cover}
  .avatar .plus{position:absolute;right:-2px;bottom:-2px;background:#f43f5e;color:#fff;border-radius:999px;width:22px;height:22px;display:grid;place-items:center;border:2px solid #fff;font-weight:900}

  /* крутилка-пластинка */
  .disc{width:48px;height:48px;border-radius:999px;border:2px solid #fff;overflow:hidden;animation:spin 4s linear infinite}
  .disc img{width:100%;height:100%;object-fit:cover}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* подписи + прогресс */
  .meta{position:absolute;left:14px;right:94px;bottom:24px;color:#fff;text-shadow:0 2px 10px rgba(0,0,0,.5)}
  .title{font-weight:900;font-size:16px}
  .hashtags{opacity:.95;color:#e5e7eb;font-size:13px;margin-top:6px}
  .progress{position:absolute;left:0;right:0;bottom:0;height:3px;background:rgba(255,255,255,.25)}
  .bar{height:100%;width:0;background:#fff}

  /* лайк-вспышка */
  .heart-pop{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) scale(.6);opacity:0;pointer-events:none;transition:transform .18s ease,opacity .18s ease;font-size:64px}
  .heart-pop.show{opacity:1;transform:translate(-50%,-50%) scale(1.15)}

  /* скелетон */
  .skeleton{height:calc(100dvh - var(--navh));background:
    linear-gradient(#0b0b0b,#0b0b0b) padding-box,
    linear-gradient(90deg,#111319,#1b1f2b 20%,#111319 40%) border-box;
    border:1px solid transparent;background-size:200% 100%;animation:sh 1.1s infinite}
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}

  /* чат справа (оставил как было) */
  .chat-dock{position:fixed;top:var(--navh);right:0;bottom:0;width:var(--dockw);background:#fff;border-left:1px solid var(--line);display:none;flex-direction:column;z-index:7}
  .dock-head{padding:10px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
  .dock-body{display:flex;min-height:0;flex:1}
  .dock-left{width:44%;border-right:1px solid var(--line);padding:8px;overflow:auto}
  .dock-right{flex:1;display:flex;flex-direction:column}
  .dock-msgs{flex:1;overflow:auto;padding:8px}
  .composer{display:flex;gap:8px;padding:8px;border-top:1px solid var(--line)}

  /* комменты — bottom-sheet */
  .comments{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.45);z-index:20}
  .sheet{width:100%;max-width:720px;background:#fff;border-radius:16px 16px 0 0;border:1px solid var(--line);max-height:88dvh;display:flex;flex-direction:column}
  .sh-head{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
  .sh-title{font-weight:900;flex:1;text-align:center}
  .sh-list{padding:8px 14px;overflow:auto}
  .comm{display:flex;gap:10px;margin:10px 0}
  .comm .ava{width:36px;height:36px;border-radius:999px;background:#f7f7fb;border:1px solid var(--line);overflow:hidden}
  .comm .ava img{width:100%;height:100%;object-fit:cover}
  .comm .body{flex:1}
  .name{font-weight:800;font-size:14px}
  .text{margin:3px 0 4px;line-height:1.35}
  .meta-row{display:flex;gap:14px;align-items:center;color:#64748b;font-size:12px}

  /* нижняя навигация */
  nav.bottom{background:#fff;border-top:1px solid var(--line)}
</style>
</head>
<body>
<header>
  <div class="brand">mebelplace</div><div style="flex:1"></div>
  <button id="btnRefresh" class="btn">Обновить</button>
</header>

<main>
  <div class="wrap">
    <div class="feed" id="feed">
      <div class="feed-inner" id="feedInner">
        <div class="skeleton"></div>
      </div>
    </div>

    <!-- ПК: док чата справа (как было у тебя) -->
    <aside class="chat-dock" id="chatDock" aria-label="Чат">
      <div class="dock-head">
        <strong style="font-weight:800">Чат</strong><div style="flex:1"></div>
        <input id="dockPeer" class="input" placeholder="UID" style="width:110px;height:40px">
        <button id="dockOpen" class="btn">Открыть</button>
      </div>
      <div class="dock-body">
        <div class="dock-left" id="dockDialogs"><div class="muted">Загружаем…</div></div>
        <div class="dock-right">
          <div class="chat-cell" id="dockTitle">Выбери диалог</div>
          <div class="dock-msgs" id="dockMsgs"></div>
          <div class="composer">
            <input id="dockText" class="input" placeholder="Сообщение">
            <button id="dockSend" class="btn btn-primary">Отправить</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Комменты -->
    <div class="comments" id="comments">
      <div class="sheet">
        <div class="sh-head">
          <div class="sh-title"><span id="cCount">Комментарии</span></div>
          <button id="cClose" class="btn close-x">✕</button>
        </div>
        <div class="sh-list" id="cList"></div>
        <div class="sh-compose">
          <input id="cInput" class="input" placeholder="Добавить комментарий…">
          <button id="cSend" class="btn btn-primary">Отправить</button>
        </div>
      </div>
    </div>
  </div>
</main>

<nav class="bottom">
  <a href="/" class="active">
    <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M8 5h8a3 3 0 0 1 3 3v8H5V8a3 3 0 0 1 3-3zm9 12v1a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2v-1zM9 8v6l5-3z"/></svg>
    Видео
  </a>
  <a href="/requests.html">
    <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M7 3h10a2 2 0 0 1 2 2v14l-7-3l-7 3V5a2 2 0 0 1 2-2z"/></svg>
    Заявки
  </a>
  <a href="/favorites.html">
    <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="m12 17.27 6.18 3.73-1.64-7.03L21 9.24l-7.19-.61L12 2 10.19 8.63 3 9.24l4.46 4.73L5.82 21z"/></svg>
    Избранные
  </a>
  <a href="/profile.html">
    <svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14z"/></svg>
    Профиль
  </a>
</nav>

<script>
(()=> {
  const $ = s => document.querySelector(s);

  /* ——— ЛЕНТА ——— */

  const feed = $('#feed');
  const inner = $('#feedInner');
  const state = { items: [], index: 0, height: 0, lock:false };

  const esc = s => String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  const avatarUrl = id => `https://api.dicebear.com/8.x/thumbs/svg?seed=${encodeURIComponent(id||'mebel')}`;
  const posterUrl = id => `https://api.dicebear.com/8.x/identicon/svg?seed=${encodeURIComponent(id||'mebel')}`;

  // прелоадим первые 3 видоса
  function preloadFirst(urls){
    urls.slice(0,3).forEach(u=>{
      const l=document.createElement('link'); l.rel='preload'; l.as='video'; l.href=u; document.head.appendChild(l);
    });
  }
  
  // «подогрев» следующего
  function prewarmNext() {
    const slides = inner.children;
    const next = slides[state.index + 1];
    const vid = next?._video ?? null; // было: next?._video , null

    if (!vid) return;
    try {
      // просим браузер заготовить буфер
      if (vid.preload !== 'auto') vid.preload = 'auto';
      // если метаданные ещё не подтянуты — пни его
      if (vid.readyState < 2) vid.load();

      // (опционально) кинем preload линк, если ещё не кинули
      const href = vid.currentSrc || vid.src;
      if (href && !document.querySelector(`link[rel="preload"][as="video"][href="${href}"]`)) {
        const l = document.createElement('link');
        l.rel = 'preload';
        l.as = 'video';
        l.href = href;
        document.head.appendChild(l);
      }
    } catch {}
  }

  function buildTopbar(){
    const tb = document.createElement('div');
    tb.className='topbar';
    tb.innerHTML = `<div class="tabs"><span>Подписки</span><span class="active">Рекомендации</span></div>`;
    return tb;
  }

  function buildVideoSlide(v, idx){
    const s=document.createElement('section'); s.className='slide';
    s.appendChild(buildTopbar());

    const wrap=document.createElement('div'); wrap.className='video';
    const vid=document.createElement('video');
    vid.setAttribute('playsinline',''); vid.setAttribute('webkit-playsinline','');
    vid.muted=true; vid.loop=true; vid.autoplay=false; vid.preload='metadata';
    vid.src=v.url; vid.poster=v.poster || posterUrl(v.owner_id||idx);
    wrap.appendChild(vid); s.appendChild(wrap);

    const heart=document.createElement('div'); heart.className='heart-pop'; heart.textContent='❤️'; s.appendChild(heart);

    // ——— ПРАВЫЙ СТОЛБИК (как TikTok)
    const stack=document.createElement('div'); stack.className='stack';

    const av=document.createElement('div'); av.className='avatar';
    av.innerHTML=`<img src="${avatarUrl(v.owner_id||idx)}" alt=""><span class="plus">+</span>`;
    stack.appendChild(av);

    const like=document.createElement('button'); like.className='circle like'; like.title='Лайк'; like.textContent='❤';
    const likeCnt=document.createElement('div'); likeCnt.className='count'; likeCnt.textContent = fmtCount(v.likes||0);
    like.onclick = async (e)=>{ e.stopPropagation(); await doLike(v.id, like, heart) };
    stack.appendChild(like); stack.appendChild(likeCnt);

    const cbtn=document.createElement('button'); cbtn.className='circle'; cbtn.title='Комментарии'; cbtn.textContent='💬';
    const cc=document.createElement('div'); cc.className='count'; cc.id=`cc-${v.id}`; cc.textContent=fmtCount(v.comments||0); cc.setAttribute('data-num', String(v.comments||0));
    cbtn.onclick=e=>{e.stopPropagation(); openComments(v.id, cc)};
    stack.appendChild(cbtn); stack.appendChild(cc);

    const share=document.createElement('button'); share.className='circle'; share.title='Поделиться'; share.textContent='↗';
    const sc=document.createElement('div'); sc.className='count'; sc.textContent=fmtCount(v.shares||0);
    share.onclick=async e=>{
      e.stopPropagation();
      const url=location.origin+'/?v='+encodeURIComponent(v.id);
      if(navigator.share){ try{ await navigator.share({title:v.title||'Видео',url}) }catch{} }
      else { try{ await navigator.clipboard.writeText(url); alert('Ссылка скопирована') }catch{ prompt('Скопируй ссылку:',url) } }
    };
    stack.appendChild(share); stack.appendChild(sc);

    const mute=document.createElement('button'); mute.className='circle'; mute.title='Звук'; mute.textContent='🔇';
    mute.onclick=e=>{ e.stopPropagation(); vid.muted = !vid.muted; mute.textContent = vid.muted ? '🔇' : '🔊' };
    stack.appendChild(mute);

    const dl=document.createElement('a'); dl.className='circle'; dl.title='Скачать'; dl.textContent='⬇'; dl.href=v.url; dl.download='';
    stack.appendChild(dl);

    const disc=document.createElement('div'); disc.className='disc';
    disc.innerHTML = `<img src="${v.poster || posterUrl(v.owner_id||idx)}" alt="">`;
    stack.appendChild(disc);

    s.appendChild(stack);

    const meta=document.createElement('div'); meta.className='meta';
    meta.innerHTML=`<div class="title">${esc(v.title||'Видео')}</div>
                    <div class="hashtags">${esc(v.tags||'#мебель #вдохновение #мастерская')}</div>`;
    s.appendChild(meta);

    const prog=document.createElement('div'); prog.className='progress'; const bar=document.createElement('div'); bar.className='bar'; prog.appendChild(bar); s.appendChild(prog);
    vid.addEventListener('timeupdate', ()=>{ if(vid.duration>0){ bar.style.width = ((vid.currentTime/vid.duration)*100).toFixed(2)+'%'; } });

    // жесты: тап — плей/пауза, даблтап — лайк
    let tapTimer=null, tapped=false;
    s.addEventListener('click', async ()=>{
      if(!tapped){
        tapped=true;
        tapTimer=setTimeout(async ()=>{tapped=false; vid.paused?await vid.play().catch(()=>{}):vid.pause()},200)
      } else {
        clearTimeout(tapTimer); tapped=false;
        await doLike(v.id, like, heart);
        heart.classList.add('show'); setTimeout(()=>heart.classList.remove('show'),180);
      }
    });

    // автоплей по видимости
    if (s._io) s._io.disconnect();
    s._io = new IntersectionObserver((ents)=>{
      for(const ent of ents){
        if(ent.isIntersecting && ent.intersectionRatio>=0.75){
          vid.play().catch(()=>{}); prewarmNext();
        } else { vid.pause(); }
      }
    }, {threshold:[0,0.75], root:feed});
    s._io.observe(s);

    s._video=vid;
    return s;
  }

  function resize(){ state.height = feed.clientHeight || window.innerHeight; inner.style.transform = `translate3d(0, ${-state.index*state.height}px, 0)` }
  window.addEventListener('resize', resize);

  function step(dir){
    if(state.lock) return;
    const slides=[...inner.children];
    const next=Math.max(0,Math.min(slides.length-1,state.index+dir));
    if(next===state.index) return;
    state.lock=true;
    const prev=slides[state.index]?._video; if(prev) prev.pause();
    state.index=next;
    inner.style.transform=`translate3d(0, ${-state.index*state.height}px, 0)`;
    setTimeout(()=>{ state.lock=false; const cur=slides[state.index]?._video; if(cur) cur.play().catch(()=>{}); prewarmNext(); }, 340);
  }

  // wheel (ПК)
  let wheelAccum=0;
  feed.addEventListener('wheel', e=>{
    e.preventDefault();
    wheelAccum+=e.deltaY;
    if(Math.abs(wheelAccum)>30){ step(wheelAccum>0?+1:-1); wheelAccum=0 }
  }, {passive:false});

  // свайпы (мобилка)
  let tsY=0, tmv=0;
  feed.addEventListener('touchstart', e=>{ tsY=e.touches[0].clientY; tmv=0 }, {passive:false});
  feed.addEventListener('touchmove',  e=>{ tmv=e.touches[0].clientY - tsY; e.preventDefault() }, {passive:false});
  feed.addEventListener('touchend',   ()=>{ if(Math.abs(tmv)>40) step(tmv<0?+1:-1); tmv=0; tsY=0 });

  // стрелки (ПК)
  window.addEventListener('keydown', e=>{
    if(e.key==='ArrowDown' || e.key==='PageDown') step(+1);
    if(e.key==='ArrowUp'   || e.key==='PageUp')   step(-1);
  });

  function appendOne(v, idx){
    const el=buildVideoSlide(v,idx);
    inner.appendChild(el);
    if(idx===0){ resize(); requestAnimationFrame(()=>{ el._video && el._video.play().catch(()=>{}); prewarmNext(); }) }
  }
  function renderAll(){ inner.innerHTML=''; state.index=0; state.items.forEach((it,i)=>appendOne(it,i)); resize() }

  async function loadFeed(){
    inner.innerHTML='<div class="skeleton"></div>';
    try{
      const r = await fetch('/api/media.php'); // реальный список с сервера
      const j = r.ok ? await r.json() : {items:[]};
      const files = (j.items||[]);
      if(!files.length){ inner.innerHTML='<div class="skeleton"></div>'; return; }

      // прелоад первых трёх
      preloadFirst(files.map(x=>x.url));

      state.items = files.map((it, i) => ({
        id: it.id || (1000+i),
        title: it.title || ('Видео ' + (i+1)),
        url: it.url,
        poster: it.poster || null,
        owner_id: it.owner_id || i,
        likes: it.likes || 0, comments: it.comments || 0, shares: it.shares || 0,
        tags: it.tags || '#мебель #вдохновение #мастерская'
      }));
      renderAll();
    }catch{
      inner.innerHTML='<div class="skeleton"></div>';
    }
  }

  function fmtCount(n){ n = Number(n||0); if(n>=1000000) return (n/1000000).toFixed(1).replace('.0','')+' млн.'; if(n>=1000) return (n/1000).toFixed(1).replace('.0','')+' тыс.'; return String(n) }

  async function doLike(id, btn, heart){
    // заглушка под твой эндпоинт — оставляю анимацию; подключишь — дерни тут свой API
    btn.classList.toggle('hearted');
    heart.classList.add('show'); setTimeout(()=>heart.classList.remove('show'),180);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    $('#btnRefresh')?.addEventListener('click', loadFeed);
    loadFeed();
  });

  /* ——— КОММЕНТЫ — реальный API ——— */
  const CS = { vid:null, listEl:$('#cList'), modal:$('#comments'), title:$('#cCount'), input:$('#cInput'), countNode:null };

  function renderComments(items){
    CS.listEl.innerHTML = '';
    if(!items.length){
      CS.listEl.innerHTML = '<div class="muted" style="padding:10px;color:#64748b">Пока нет комментариев</div>';
      CS.title.textContent = 'Комментарии';
      return;
    }
    items.forEach(c=>{
      const row=document.createElement('div'); row.className='comm';
      row.innerHTML = `
        <div class="ava"><img src="${avatarUrl(c.user||'u')}" alt=""></div>
        <div class="body">
          <div class="name">${esc(c.user||'user')}</div>
          <div class="text">${esc(c.text||'')}</div>
          <div class="meta-row"><span>${new Date(c.created_at||Date.now()).toLocaleString('ru-RU')}</span></div>
        </div>`;
      CS.listEl.appendChild(row);
    });
    CS.title.textContent = `${items.length} комментариев`;
  }

  async function openComments(vid, countNode){
    CS.vid = vid; CS.countNode = countNode || null;
    CS.modal.style.display='flex';
    CS.listEl.innerHTML = '<div class="muted" style="padding:10px">Загрузка…</div>';
    try{
      const r = await fetch('/api/comments.php?video_id='+encodeURIComponent(vid));
      const js = r.ok ? await r.json() : {items:[]};
      renderComments(js.items||[]);
    }catch{
      CS.listEl.innerHTML = '<div class="muted" style="padding:10px">Комментарии недоступны</div>';
    }
    CS.input.value=''; CS.input.focus();
  }

  $('#cClose').onclick = ()=>{ CS.modal.style.display='none' };
  $('#comments').addEventListener('click', e=>{ if(e.target.id==='comments') CS.modal.style.display='none' });

  $('#cSend').onclick = async ()=>{
    const t = CS.input.value.trim(); if(!t) return;
    try{
      const r = await fetch('/api/comments.php', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({video_id:Number(CS.vid||0), user:'you', text:t})});
      const js = r.ok ? await r.json() : null;
      if(js && js.ok){
        // prepend
        CS.listEl.insertAdjacentHTML('afterbegin',
          `<div class="comm"><div class="ava"><img src="${avatarUrl('you')}"></div><div class="body"><div class="name">вы</div><div class="text">${esc(t)}</div><div class="meta-row"><span>${new Date().toLocaleString('ru-RU')}</span></div></div></div>`);
        const cur = CS.listEl.querySelectorAll('.comm').length;
        CS.title.textContent = `${cur} комментариев`;
        if (CS.countNode) {
          const current = Number(CS.countNode.getAttribute('data-num') || 0) + 1;
          CS.countNode.setAttribute('data-num', String(current));
          CS.countNode.textContent = current >= 1000 ? (current/1000).toFixed(1).replace('.0','')+' тыс.' : String(current);
        }
        CS.input.value='';
      }
    }catch{}
  };
})();
</script>
</body>
</html>
