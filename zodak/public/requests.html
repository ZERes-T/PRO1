<!doctype html><html lang="ru"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Заявки — Zodak</title>
<link rel="stylesheet" href="/common.css"><script src="/domain-notice.js" defer></script>
<style>
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 4px}
  .chip{height:36px;padding:0 12px;border-radius:999px;border:1px solid var(--line);background:#fff;color:var(--text);font-weight:700}
  .chip.active{background:var(--accent);border-color:var(--accent);color:#fff}
  .skeleton{height:64px;border-radius:14px;border:1px solid var(--line);
    background:linear-gradient(90deg,#eef1f7,#f6f7fb 20%,#eef1f7 40%);background-size:200% 100%;animation:sh 1.1s infinite;margin:8px 0}
  @keyframes sh{0%{background-position:200% 0}100%{background-position:-200% 0}}
  .status{display:inline-flex;align-items:center;gap:6px;height:20px;padding:0 8px;border-radius:999px;background:#fff7ed;border:1px solid #fed7aa;color:#8a5b00;font-size:12px;font-weight:700}
  .money{font-weight:800}
  .sheet{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.35)}
  .box{width:100%;max-width:720px;background:#fff;border:1px solid var(--line);border-radius:20px 20px 0 0;padding:16px}
</style>
</head><body>
<header>
  <div class="title">Мои заявки</div>
  <div style="flex:1"></div>
  <button id="btnNew" class="btn btn-primary">Новая</button>
</header>

<main>
  <div class="card">
    <div class="chips">
      <button class="chip active" data-filter="all">Все</button>
      <button class="chip" data-filter="sent">Отправленные</button>
      <button class="chip" data-filter="answered">Отвеченные</button>
      <button class="chip" data-filter="archived">Архив</button>
    </div>
    <div id="list" class="list">
      <div class="skeleton"></div><div class="skeleton"></div><div class="skeleton"></div>
    </div>
  </div>
</main>

<nav class="bottom">
  <a href="/"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M8 5h8a3 3 0 0 1 3 3v8H5V8a3 3 0 0 1 3-3zm9 12v1a2 2 0 0 1-2 2H9a2 2 0 0 1-2-2v-1zM9 8v6l5-3z"/></svg>Видео</a>
  <a href="/requests.html" class="active"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M7 3h10a2 2 0 0 1 2 2v14l-7-3l-7 3V5a2 2 0 0 1 2-2z"/></svg>Заявки</a>
  <a href="/favorites.html"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="m12 17.27 6.18 3.73-1.64-7.03L21 9.24l-7.19-.61L12 2 10.19 8.63 3 9.24l4.46 4.73L5.82 21z"/></svg>Избранные</a>
  <a href="/profile.html"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="currentColor" d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-5 0-9 2.5-9 5.5A1.5 1.5 0 0 0 4.5 21h15A1.5 1.5 0 0 0 21 19.5C21 16.5 17 14 12 14z"/></svg>Профиль</a>
</nav>

<!-- Sheet: новая заявка -->
<div id="sheet" class="sheet" role="dialog" aria-modal="true">
  <div class="box">
    <div class="row" style="justify-content:space-between"><strong>Новая заявка</strong><button id="btnClose" class="btn">Закрыть</button></div>
    <div id="mErr" class="msg err"></div><div id="mOk" class="msg ok"></div>
    <label class="muted" style="display:block;margin-top:8px">Заголовок</label>
    <input id="title" class="input" placeholder="Сделать кухню под ключ">
    <label class="muted" style="display:block;margin-top:8px">Описание</label>
    <textarea id="desc" class="input" placeholder="Размеры, материалы, сроки"></textarea>
    <label class="muted" style="display:block;margin-top:8px">Бюджет (₽)</label>
    <input id="budget" class="input" type="number" inputmode="numeric" placeholder="150000">
    <div class="row" style="justify-content:flex-end;margin-top:10px"><button id="btnSave" class="btn btn-primary">Создать</button></div>
  </div>
</div>

<script>
(()=>{const $=s=>document.querySelector(s);
function tok(){return localStorage.getItem('token')||''} if(!tok()){location.replace('/login.html?next=/requests.html')}
function hdr(){return {'Authorization':'Bearer '+tok(),'Content-Type':'application/json'}}
const esc=s=>String(s??'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const S={all:[],filter:'all'};

function statusChip(s){const map={answered:'Ответили',archived:'Архив',sent:'Отправлена',new:'Новая',open:'Открыта'};return `<span class="status">${esc(map[s]||s||'новая')}</span>`}
function cell(r){
  const el=document.createElement('div'); el.className='cell';
  el.innerHTML=`<div>
    <b>${esc(r.title||'Заявка')}</b>
    <div class="muted" style="font-size:12px">${statusChip(r.status)} • ${esc(r.created_at||'')}</div>
  </div>
  <div class="money">${r.budget?('₽'+r.budget.toLocaleString('ru-RU')):''}</div>`;
  return el;
}
function render(){
  const box=$("#list"); box.innerHTML='';
  const arr=S.all.filter(x=>{
    if(S.filter==='all') return true;
    if(S.filter==='sent') return (x.status||'').toLowerCase().includes('sent');
    return (x.status||'').toLowerCase()===S.filter;
  });
  if(!arr.length){ box.innerHTML='<div class="muted" style="padding:8px 2px">Пока пусто</div>'; return }
  arr.forEach(x=> box.appendChild(cell(x)));
}
async function load(){ $("#list").innerHTML='<div class="skeleton"></div><div class="skeleton"></div>'; const r=await fetch('/api/requests',{headers:hdr()}); const ct=r.headers.get('content-type')||''; const j=ct.includes('json')?await r.json().catch(()=>({})):{};
  S.all=(j.items||j||[]); render();
}

function openSheet(){ $('#sheet').style.display='flex'; $('#title').focus() }
function closeSheet(){ $('#sheet').style.display='none'; $('#mErr').style.display='none'; $('#mOk').style.display='none' }
async function save(){
  const t=$('#title').value.trim(), d=$('#desc').value.trim(), b=Number($('#budget').value||0);
  if(t.length<3){ $('#mErr').textContent='Слишком короткий заголовок'; $('#mErr').style.display='block'; return }
  $('#btnSave').disabled=true; $('#btnSave').textContent='Создаём…';
  try{
    const r=await fetch('/api/requests',{method:'POST',headers:hdr(),body:JSON.stringify({title:t,description:d,budget:b})});
    if(!r.ok) throw new Error('Не удалось создать');
    $('#mOk').textContent='Создано'; $('#mOk').style.display='block';
    setTimeout(()=>{ closeSheet(); load() },500);
  }catch(e){ $('#mErr').textContent=e.message||'Ошибка'; $('#mErr').style.display='block' }
  finally{ $('#btnSave').disabled=false; $('#btnSave').textContent='Создать' }
}

document.addEventListener('DOMContentLoaded',()=>{
  load();
  $('#btnNew').onclick=openSheet; $('#btnClose').onclick=closeSheet;
  $('#sheet').addEventListener('click',e=>{ if(e.target.id==='sheet') closeSheet() });
  $('#btnSave').onclick=save;
  document.querySelectorAll('.chip').forEach(b=> b.onclick=()=>{ document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); b.classList.add('active'); S.filter=b.dataset.filter; render(); });
});
})();
</script>
</body></html>
